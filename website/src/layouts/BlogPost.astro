---
import Layout from "./Layout.astro";
import "../styles/global.css";
import { Image } from "astro:assets";

import {
  formatDateLong,
  parseCustomDate,
  getWordCount,
  formatWordCount,
  calculateReadingTime,
  formatReadingTime,
} from "../lib/date.ts";
import {
  processExcalidrawImage,
  extractBannerFilename,
} from "../lib/excalidraw";
import { getBlogPosts } from "../lib/blog";
import SocialIcons from "../components/SocialIcons.astro";

const { frontmatter, headings, rawContent } = Astro.props;
const { title, description, date, tags, banner } = frontmatter;

// Format the date (only date part, no time)
const formattedDate = date ? formatDateLong(parseCustomDate(date)) : "";

// Calculate word count and reading time
const content = rawContent ? rawContent() : "";
const wordCount = getWordCount(content);
const readingTime = calculateReadingTime(wordCount);
const wordCountFormatted = formatWordCount(wordCount);
const readingTimeFormatted = formatReadingTime(readingTime);

// Handle banner image if it exists (supports both local Obsidian paths and URLs)
let bannerImage: any = null;
let bannerImageUrl: string | null = null;
let bannerLightImage: any = null;
let bannerDarkImage: any = null;
let isExcalidrawBanner = false;

if (banner) {
  const bannerFilename = extractBannerFilename(banner);

  // Check if it's a URL (starts with http:// or https://)
  if (
    bannerFilename.startsWith("http://") ||
    bannerFilename.startsWith("https://")
  ) {
    bannerImage = bannerFilename;
    bannerImageUrl = bannerFilename;
  } else {
    // Get the current file path to determine the slug
    const url = Astro.url.pathname;
    const pathParts = url.split("/").filter(Boolean);
    const slug =
      pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

    try {
      const images = import.meta.glob<{ default: ImageMetadata }>(
        "/src/pages/blog/**/_assets/**/*.{png,jpg,jpeg,gif,webp,svg}",
        { eager: true },
      );

      // Check if this is an Excalidraw image
      const excalidrawResult = processExcalidrawImage(
        bannerFilename,
        images,
        slug,
      );

      if (excalidrawResult.isExcalidraw) {
        isExcalidrawBanner = true;
        bannerLightImage = excalidrawResult.lightImage;
        bannerDarkImage = excalidrawResult.darkImage;

        // Use fallback for social media (prefers light variant)
        bannerImage = excalidrawResult.fallbackImage;
        if (bannerImage && excalidrawResult.baseName) {
          // Force use dark variant for social media preview if available
          if (excalidrawResult.darkImage) {
            bannerImageUrl = new URL(
              excalidrawResult.darkImage.src,
              Astro.site,
            ).toString();
          } else {
            bannerImageUrl = new URL(bannerImage.src, Astro.site).toString();
          }
        }
      } else {
        // Regular image handling
        const bannerPath = bannerFilename.startsWith("./")
          ? `/src/pages/blog/${slug}/_assets/${bannerFilename.slice(2)}`
          : `/src/pages/blog/${slug}/_assets/${bannerFilename}`;
        const localImage = images[bannerPath];
        if (localImage) {
          bannerImage = localImage.default;
          // Create full URL for social media
          bannerImageUrl = new URL(bannerImage.src, Astro.site).toString();
        }
      }
    } catch (e) {
      console.warn("Banner image not found:", banner);
    }
  }
}

// Use banner image for social media, otherwise use favicon
const socialImage = bannerImageUrl || `${Astro.site}favicon.ico`;

// Create fun blog description
const blogDescription =
  description ||
  "üí° Dive into the digital rabbit hole! Tech tales, DevOps adventures, and code wisdom served with a side of chaos. Warning: May contain terrible jokes and actual useful information.";

// Filter headings to only include h2 and h3 for TOC
const tocHeadings =
  headings?.filter((h: any) => h.depth >= 2 && h.depth <= 3) || [];

// Get previous and next posts
const posts = getBlogPosts();
const currentPath = Astro.url.pathname.replace(/\/$/, "");
const currentPostIndex = posts.findIndex(
  (p) => p.url.replace(/\/$/, "") === currentPath,
);

const nextPost = currentPostIndex > 0 ? posts[currentPostIndex - 1] : null; // Newer post
const prevPost =
  currentPostIndex < posts.length - 1 ? posts[currentPostIndex + 1] : null; // Older post
---

<Layout
  title={title}
  description={blogDescription}
  image={socialImage}
  bodyClass="!overflow-visible !h-auto scroll-smooth"
>
  <div
    class="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)] relative"
  >
    <!-- Scanline effect -->
    <div class="scanlines absolute inset-0 pointer-events-none opacity-20">
    </div>

    <div
      class="max-w-7xl mx-auto px-2 sm:px-6 py-8 sm:py-16 lg:flex lg:gap-12 lg:items-start relative z-10 overflow-x-hidden"
    >
      <!-- Main content -->
      <div class="flex-1 w-full min-w-0 max-w-none lg:max-w-[calc(100%-20rem)]">
        <!-- Terminal-style breadcrumb navigation -->
        <div class="mb-8 sm:mb-12">
          <p class="text-sm font-mono text-[var(--text-tertiary)] mb-4">
            <span class="text-terminal-green">milind@blog</span>:<span
              class="text-terminal-blue">~/posts</span
            >$ cat {title.toLowerCase().replace(/\s+/g, "-")}.md
          </p>
          <a
            href="/blog"
            class="group inline-flex items-center gap-2 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"
          >
            <div
              class="p-2 rounded-lg bg-[var(--bg-elevated)] group-hover:bg-[var(--bg-secondary)] transition-colors border border-[var(--border-color)]"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"></path>
              </svg>
            </div>
            <span class="font-medium">Back to Blog</span>
          </a>
        </div>

        <!-- Mobile TOC - Collapsible inline section -->
        {
          tocHeadings.length > 0 && (
            <details class="lg:hidden mb-8 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-xl overflow-hidden">
              <summary class="cursor-pointer px-6 py-4 font-bold text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] transition-colors flex items-center justify-between group">
                <span class="flex items-center gap-2">
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h7"
                    />
                  </svg>
                  Table of Contents
                </span>
                <svg
                  class="w-5 h-5 transition-transform group-open:rotate-180"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </summary>
              <nav class="px-6 py-4 border-t border-[var(--border-color)]">
                <ul class="space-y-1">
                  {tocHeadings.map((heading: any) => (
                    <li
                      style={`margin-left: ${(heading.depth - 2) * 1}rem`}
                      class=""
                    >
                      <a
                        href={`#${heading.slug}`}
                        class="mobile-toc-link block py-2 px-3 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] rounded transition-all text-sm border-l-2 border-transparent hover:border-[var(--text-primary)]"
                        data-heading-id={heading.slug}
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            </details>
          )
        }

        <!-- Article header with gradient -->
        <article class="prose prose-invert prose-lg max-w-none">
          <header
            class="mb-8 sm:mb-12 pb-8 border-b border-[var(--border-color)]"
          >
            <h1
              class="text-4xl sm:text-5xl md:text-6xl font-bold mb-6 leading-tight"
            >
              <span class="cyber-text">{title}</span>
            </h1>

            {
              description && (
                <p class="text-base sm:text-lg text-[var(--text-secondary)] mb-6 leading-relaxed">
                  {description}
                </p>
              )
            }

            {
              (bannerImage || isExcalidrawBanner) && (
                <div
                  class={
                    isExcalidrawBanner
                      ? "relative my-12 -mx-2 sm:mx-0 rounded-2xl overflow-hidden"
                      : "my-8 -mx-2 sm:mx-0 rounded-none sm:rounded-2xl overflow-hidden"
                  }
                >
                  {isExcalidrawBanner ? (
                    <>
                      {bannerLightImage && (
                        <Image
                          src={bannerLightImage}
                          alt={title}
                          width={1200}
                          height={675}
                          class="hidden [.latte_&]:block w-full h-auto m-0! border-none! rounded-none! shadow-none!"
                          loading="eager"
                        />
                      )}
                      {bannerDarkImage && (
                        <Image
                          src={bannerDarkImage}
                          alt={title}
                          width={1200}
                          height={675}
                          class="block [.latte_&]:hidden w-full h-auto m-0! border-none! rounded-none! shadow-none!"
                          loading="eager"
                        />
                      )}
                    </>
                  ) : typeof bannerImage === "string" ? (
                    <img
                      src={bannerImage}
                      alt={title}
                      class="w-full h-auto object-cover"
                      loading="eager"
                    />
                  ) : (
                    <Image
                      src={bannerImage}
                      alt={title}
                      width={1200}
                      height={675}
                      class="w-full h-auto object-cover"
                      loading="eager"
                    />
                  )}
                </div>
              )
            }

            <div class="flex flex-wrap items-center gap-6 text-sm mb-8">
              {
                formattedDate && (
                  <div class="flex items-center gap-2.5 px-3 py-1.5 rounded-lg bg-[var(--bg-elevated)] border border-[var(--border-color)]">
                    <i class="nf nf-md-calendar_month w-4 h-4 text-[var(--color-cyber-purple)]" />
                    <time
                      datetime={date}
                      class="font-mono font-medium text-[var(--text-primary)]"
                    >
                      {formattedDate}
                    </time>
                  </div>
                )
              }

              {
                wordCount > 0 && (
                  <div class="flex items-center gap-2.5 px-3 py-1.5 rounded-lg bg-[var(--bg-elevated)] border border-[var(--border-color)]">
                    <i class="nf nf-md-file_document_outline w-4 h-4 text-[var(--color-terminal-green)]" />
                    <span class="font-mono font-medium text-[var(--text-primary)]">
                      {wordCount} words
                    </span>
                  </div>
                )
              }

              {
                readingTime > 0 && (
                  <div class="flex items-center gap-2.5 px-3 py-1.5 rounded-lg bg-[var(--bg-elevated)] border border-[var(--border-color)]">
                    <i class="nf nf-md-clock_outline w-4 h-4 text-[var(--color-terminal-yellow)]" />
                    <span class="font-mono font-medium text-[var(--text-primary)]">
                      {readingTimeFormatted}
                    </span>
                  </div>
                )
              }
            </div>

            {
              tags && tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-6">
                  {tags.map((tag: string) => (
                    <span class="px-3 py-1 text-sm font-mono bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded">
                      #{tag}
                    </span>
                  ))}
                </div>
              )
            }
          </header>

          <!-- Article content with enhanced styling -->
          <div
            class="blog-content w-full break-words overflow-hidden text-base md:text-lg leading-relaxed text-[var(--text-primary)]
            [&_:is(h1,h2,h3,h4,h5,h6)]:text-[var(--text-primary)] [&_:is(h1,h2,h3,h4,h5,h6)]:font-bold [&_:is(h1,h2,h3,h4,h5,h6)]:mt-12 [&_:is(h1,h2,h3,h4,h5,h6)]:mb-6 [&_:is(h1,h2,h3,h4,h5,h6)]:leading-tight [&_:is(h1,h2,h3,h4,h5,h6)]:scroll-mt-8
            [&_h1]:text-4xl
            [&_h2]:text-3xl
            [&_h3]:text-2xl
            [&_h4]:text-xl
            [&_p]:mb-6 [&_p]:leading-relaxed
            [&_a]:text-[var(--color-cyber-purple)] [&_a]:underline [&_a]:decoration-[var(--color-cyber-purple)] [&_a]:underline-offset-4 [&_a]:transition-all
            [&_a:hover]:text-[var(--color-cyber-cyan)] [&_a:hover]:decoration-[var(--color-cyber-cyan)]
            [&_img]:rounded-xl [&_img]:my-10 [&_img]:w-full [&_img]:h-auto [&_img]:shadow-lg
            [&_:is(ul,ol)]:mb-6 [&_:is(ul,ol)]:pl-8
            [&_li]:mb-3 [&_li]:pl-2 [&_li]:text-[var(--text-secondary)]
            [&_ul_li]:list-none [&_ul_li]:relative [&_ul_li]:before:content-['‚ñπ'] [&_ul_li]:before:absolute [&_ul_li]:before:-left-6 [&_ul_li]:before:text-[var(--color-terminal-green)] [&_ul_li]:before:font-bold
            [&_ol_li]:list-decimal [&_ol_li]:list-outside [&_ol_li]:marker:text-[var(--color-cyber-purple)] [&_ol_li]:marker:font-bold
            [&_code]:bg-[var(--bg-elevated)] [&_code]:px-2 [&_code]:py-1 [&_code]:rounded-md [&_code]:text-[0.9em] [&_code]:font-mono
            [&_pre]:bg-[var(--bg-elevated)] [&_pre]:p-6 [&_pre]:rounded-2xl [&_pre]:overflow-x-auto [&_pre]:my-8 [&_pre]:border [&_pre]:border-[var(--border-color)]
            [&_pre_code]:bg-transparent [&_pre_code]:p-0 [&_pre_code]:border-none [&_pre_code]:shadow-none
            [&_blockquote]:border-l-4 [&_blockquote]:border-[var(--color-cyber-purple)] [&_blockquote]:pl-6 [&_blockquote]:py-2 [&_blockquote]:italic [&_blockquote]:text-[var(--text-secondary)] [&_blockquote]:my-8 [&_blockquote]:bg-[var(--bg-elevated)] [&_blockquote]:rounded-r-lg
            [&_table]:w-full [&_table]:border-collapse [&_table]:my-8 [&_table]:rounded-lg [&_table]:overflow-hidden [&_table]:border [&_table]:border-[var(--border-color)]
            [&_:is(th,td)]:border [&_:is(th,td)]:border-[var(--border-color)] [&_:is(th,td)]:p-3 [&_:is(th,td)]:text-left
            [&_th]:bg-[var(--bg-elevated)] [&_th]:font-bold [&_th]:text-[var(--color-cyber-purple)]
            [&_tr:nth-child(even)]:bg-[var(--bg-elevated)]
            [&_hr]:border-none [&_hr]:h-px [&_hr]:bg-gradient-to-r [&_hr]:from-transparent [&_hr]:via-[var(--border-color)] [&_hr]:to-transparent [&_hr]:my-12
            [&_strong]:text-[var(--text-primary)] [&_strong]:font-bold
            [&_em]:text-[var(--text-secondary)]"
          >
            <slot />
          </div>

          <!-- Back to blog footer -->
          <footer class="mt-8 pt-8 border-t border-[var(--border-color)]">
            <div class="mb-4">
              <p class="text-sm font-mono text-[var(--text-tertiary)] mb-4">
                <span class="text-terminal-green">milind@blog</span>:<span
                  class="text-terminal-blue">~/posts</span
                >$ cd ..
              </p>
              <a
                href="/blog"
                class="group inline-flex items-center gap-2 text-cyber-purple hover:text-cyber-cyan transition-colors font-medium"
              >
                <svg
                  class="w-5 h-5 group-hover:-translate-x-1 transition-transform"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                View all posts
              </a>
            </div>

            <!-- Social Links & RSS -->
            <div class="mt-4 pt-4">
              <div class="flex flex-col gap-6">
                <div>
                  <h3
                    class="text-sm font-mono text-[var(--text-tertiary)] mb-4"
                  >
                    <span class="text-terminal-green">$</span> Connect with me:
                  </h3>
                  <div class="mt-2">
                    <SocialIcons />
                  </div>
                </div>

                {
                  (nextPost || prevPost) && (
                    <div class="mt-4 pt-4  grid grid-cols-1 sm:grid-cols-2 gap-6">
                      {prevPost ? (
                        <a
                          href={prevPost.url}
                          class="group flex flex-col p-4 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-xl hover:border-[var(--color-cyber-purple)] transition-all"
                        >
                          <span class="text-sm text-[var(--text-tertiary)] mb-2 group-hover:text-[var(--color-cyber-purple)] transition-colors">
                            ‚Üê Previous Post
                          </span>
                          <span class="font-medium text-[var(--text-primary)] line-clamp-2">
                            {prevPost.title}
                          </span>
                        </a>
                      ) : (
                        <div />
                      )}

                      {nextPost ? (
                        <a
                          href={nextPost.url}
                          class="group flex flex-col p-4 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-xl hover:border-[var(--color-cyber-purple)] transition-all text-right items-end"
                        >
                          <span class="text-sm text-[var(--text-tertiary)] mb-2 group-hover:text-[var(--color-cyber-purple)] transition-colors">
                            Next Post ‚Üí
                          </span>
                          <span class="font-medium text-[var(--text-primary)] line-clamp-2">
                            {nextPost.title}
                          </span>
                        </a>
                      ) : (
                        <div />
                      )}
                    </div>
                  )
                }

                <div class="mt-8 pt-4 border-t border-[var(--border-color)]">
                  <p class="text-xs font-mono text-[var(--text-tertiary)]">
                    <span class="text-terminal-blue">¬©</span>
                    {new Date().getFullYear()} Milind Madhukar
                  </p>
                </div>
              </div>
            </div>
          </footer>
        </article>
      </div>

      <!-- Desktop TOC Sidebar -->
      {
        tocHeadings.length > 0 && (
          <aside class="hidden lg:block lg:w-72 xl:w-80 flex-shrink-0">
            <div class="sticky top-8">
              <div class="bg-[var(--bg-elevated)] backdrop-blur-sm border border-[var(--border-color)] rounded-2xl p-6 shadow-xl">
                <h2 class="text-lg font-bold mb-4 text-[var(--text-primary)]">
                  Table of Contents
                </h2>
                <nav class="toc-nav">
                  <ul class="space-y-1">
                    {tocHeadings.map((heading: any) => (
                      <li
                        style={`margin-left: ${(heading.depth - 2) * 0.75}rem`}
                        class=""
                      >
                        <a
                          href={`#${heading.slug}`}
                          class="toc-link block py-2 px-3 text-[var(--text-secondary)] hover:text-cyber-purple hover:bg-cyber-purple/10 rounded transition-all text-sm border-l-2 border-transparent hover:border-cyber-purple"
                          data-heading-id={heading.slug}
                        >
                          {heading.text}
                        </a>
                      </li>
                    ))}
                  </ul>
                </nav>
              </div>
            </div>
          </aside>
        )
      }
    </div>
  </div>
</Layout>

<script>
  // Auto-close mobile TOC details when clicking a link
  const mobileTocDetails = document.querySelector("details.lg\\:hidden");
  if (mobileTocDetails) {
    const mobileTocLinks =
      mobileTocDetails.querySelectorAll(".mobile-toc-link");
    mobileTocLinks.forEach((link) => {
      link.addEventListener("click", () => {
        mobileTocDetails.removeAttribute("open");
      });
    });
  }

  // Active section highlighting with intersection observer
  const observerOptions = {
    rootMargin: "-80px 0px -80% 0px",
    threshold: 0,
  };

  const headingElements = document.querySelectorAll(
    ".blog-content h2, .blog-content h3",
  );
  const tocLinks = document.querySelectorAll(".toc-link, .mobile-toc-link");

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        // Remove active class from all links
        tocLinks.forEach((link) => {
          link.classList.remove("active");
          // Remove Tailwind classes for active state if they were applied directly
          link.classList.remove(
            "text-[var(--color-cyber-purple)]",
            "bg-[oklch(0.65_0.28_290_/_0.15)]",
            "border-l-[var(--color-cyber-purple)]",
          );
        });
        // Add active class to current link (both desktop and mobile)
        const activeLinkDesktop = document.querySelector(
          `.toc-link[data-heading-id="${id}"]`,
        );
        const activeLinkMobile = document.querySelector(
          `.mobile-toc-link[data-heading-id="${id}"]`,
        );

        const activeClasses = [
          "text-[var(--color-cyber-purple)]",
          "bg-[oklch(0.65_0.28_290_/_0.15)]",
          "border-l-[var(--color-cyber-purple)]",
        ];

        if (activeLinkDesktop) {
          activeLinkDesktop.classList.add("active");
          activeLinkDesktop.classList.add(...activeClasses);
        }
        if (activeLinkMobile) {
          activeLinkMobile.classList.add("active");
          activeLinkMobile.classList.add(...activeClasses); // Mobile might use different styles? preserving previous logical parity
        }
      }
    });
  }, observerOptions);

  headingElements.forEach((heading) => observer.observe(heading));

  // Enhanced image zoom functionality
  function enhanceBlogImages() {
    const blogImages = document.querySelectorAll(".blog-content img");

    blogImages.forEach((imgEl, index) => {
      const img = imgEl as HTMLImageElement;

      // Skip if already enhanced
      if (img.hasAttribute("data-zoom-enhanced")) return;

      img.setAttribute("data-zoom-enhanced", "true");
      const imageId = `blog-img-${index}`;

      // Wrap image in a container with cursor pointer
      const wrapper = document.createElement("div");
      wrapper.className =
        "blog-image-wrapper transition-all duration-300 hover:-translate-y-0.5";
      wrapper.style.cssText = "position: relative; cursor: zoom-in;";
      const parent = img.parentNode;
      if (parent) {
        parent.insertBefore(wrapper, img);
        wrapper.appendChild(img);
      }

      // Create modal with Tailwind classes
      const modal = document.createElement("div");
      modal.id = `modal-${imageId}`;
      // Fixed overlay, hidden by default, flex when active
      modal.className =
        "fixed inset-0 z-[9999] hidden items-center justify-center opacity-0 transition-opacity duration-300 [&.active]:flex [&.active]:opacity-100";
      modal.innerHTML = `
        <div class="modal-backdrop absolute inset-0 bg-black/90"></div>
        <div class="modal-content relative w-[95vw] h-[95vh] flex items-center justify-center z-10">
          <div class="modal-instructions absolute top-4 left-1/2 -translate-x-1/2 flex flex-col gap-2 items-center z-10 pb-4">
            <div class="instruction-badge bg-white/10 border border-white/20 rounded-full px-5 py-2 text-white text-sm sm:text-xs font-medium backdrop-blur-md animate-[bounce_1s_infinite]" data-desktop-hint>
              Click & hold to activate magnifying glass
            </div>
            <div class="instruction-badge hidden bg-white/10 border border-white/20 rounded-full px-5 py-2 text-white text-sm sm:text-xs font-medium backdrop-blur-md animate-[bounce_1s_infinite]" data-mobile-hint>
              Pinch to zoom
            </div>
            <div class="instruction-badge hidden bg-white/10 border border-white/20 rounded-full px-5 py-2 text-white text-sm sm:text-xs font-medium backdrop-blur-md animate-[bounce_1s_infinite]" data-magnify-hint>
              Scroll to zoom in/out
            </div>
          </div>
          <button class="modal-close absolute top-4 right-4 bg-white/10 border border-white/20 rounded-lg p-3 text-white cursor-pointer z-10 transition-all duration-200 backdrop-blur-md hover:bg-white/20 hover:scale-110" aria-label="Close">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <div class="modal-image-container relative max-w-[90%] max-h-[90%] flex items-center justify-center sm:max-w-[95%]">
            <img src="${img.src}" alt="${img.alt}" class="modal-image max-w-full max-h-[85vh] w-auto h-auto object-contain rounded-lg shadow-2xl cursor-pointer [&.magnifying]:cursor-none" data-full-image />
            <div class="magnify-lens absolute w-[200px] h-[200px] border-[3px] border-white rounded-full pointer-events-none hidden bg-no-repeat shadow-[0_0_20px_rgba(0,0,0,0.5),inset_0_0_20px_rgba(255,255,255,0.2)] z-50 overflow-hidden [&.active]:block" data-lens></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Detect touch device
      const isTouchDevice =
        "ontouchstart" in window || navigator.maxTouchPoints > 0;

      // Modal functionality
      const modalBackdrop = modal.querySelector(".modal-backdrop");
      const modalClose = modal.querySelector(".modal-close");
      const modalImage = modal.querySelector(
        "[data-full-image]",
      ) as HTMLImageElement | null;
      const lens = modal.querySelector("[data-lens]") as HTMLElement | null;
      const magnifyHint = modal.querySelector(
        "[data-magnify-hint]",
      ) as HTMLElement | null;
      const desktopHint = modal.querySelector(
        "[data-desktop-hint]",
      ) as HTMLElement | null;
      const mobileHint = modal.querySelector(
        "[data-mobile-hint]",
      ) as HTMLElement | null;

      let magnifyActive = false;
      let zoomLevel = 3;
      const minZoom = 1.5;
      const maxZoom = 5;
      let lensSize = 0;

      // Open modal
      wrapper.addEventListener("click", () => {
        modal.classList.add("active");
        document.body.style.overflow = "hidden";

        // Show appropriate hint based on device type
        if (isTouchDevice) {
          if (mobileHint) mobileHint.classList.remove("hidden");
          if (desktopHint) desktopHint.classList.add("hidden");
        } else {
          if (desktopHint) desktopHint.classList.remove("hidden");
          if (mobileHint) mobileHint.classList.add("hidden");

          // Calculate and set lens size to 80% of viewport height
          if (lens) {
            lensSize = window.innerHeight * 0.8;
            lens.style.width = `${lensSize}px`;
            lens.style.height = `${lensSize}px`;
          }
        }
      });

      // Close modal
      const closeModal = () => {
        modal.classList.remove("active");
        document.body.style.overflow = "";
        magnifyActive = false;
        if (lens) {
          lens.classList.remove("active");
          lens.style.display = "none";
        }
        if (modalImage) modalImage.classList.remove("magnifying");
        zoomLevel = 3;
        if (magnifyHint) magnifyHint.classList.add("hidden");
        if (desktopHint) desktopHint.classList.remove("hidden");
        if (mobileHint) mobileHint.classList.add("hidden");
      };

      modalBackdrop?.addEventListener("click", closeModal);
      modalClose?.addEventListener("click", closeModal);

      // ESC key to close
      const handleEsc = (e: KeyboardEvent) => {
        if (e.key === "Escape" && modal.classList.contains("active")) {
          closeModal();
        }
      };
      document.addEventListener("keydown", handleEsc);

      // Only add magnifying glass functionality on non-touch devices
      if (!isTouchDevice) {
        // Activate magnifying glass on mousedown
        modalImage?.addEventListener("mousedown", (e: MouseEvent) => {
          e.preventDefault();
          magnifyActive = true;

          if (lens && modalImage) {
            // Show lens at cursor position immediately
            const rect = modalImage.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            lens.style.left = `${x - lensSize / 2}px`;
            lens.style.top = `${y - lensSize / 2}px`;
            lens.style.display = "block";
            lens.classList.add("active");

            // Calculate and set initial background
            const bgX = -(x * zoomLevel - lensSize / 2);
            const bgY = -(y * zoomLevel - lensSize / 2);
            lens.style.backgroundImage = `url('${modalImage.src}')`;
            lens.style.backgroundSize = `${rect.width * zoomLevel}px ${rect.height * zoomLevel}px`;
            lens.style.backgroundPosition = `${bgX}px ${bgY}px`;
          }

          if (modalImage) modalImage.classList.add("magnifying");
          if (magnifyHint) magnifyHint.classList.remove("hidden");
          if (desktopHint) desktopHint.classList.add("hidden");
        });

        // Deactivate magnifying glass on mouseup
        const deactivateMagnify = () => {
          magnifyActive = false;
          if (lens) {
            lens.classList.remove("active");
            lens.style.display = "none";
          }
          if (modalImage) modalImage.classList.remove("magnifying");
          if (magnifyHint) magnifyHint.classList.add("hidden");
          if (desktopHint) desktopHint.classList.remove("hidden");
        };

        modalImage?.addEventListener("mouseup", deactivateMagnify);
        modalImage?.addEventListener("mouseleave", deactivateMagnify);
        document.addEventListener("mouseup", () => {
          if (magnifyActive && modal.classList.contains("active")) {
            deactivateMagnify();
          }
        });

        // Magnifying glass movement
        modalImage?.addEventListener("mousemove", (e: MouseEvent) => {
          if (!magnifyActive || !lens || !modalImage) return;

          const rect = modalImage.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // Position the lens
          lens.style.left = `${x - lensSize / 2}px`;
          lens.style.top = `${y - lensSize / 2}px`;

          // Calculate background position for zoom effect
          const bgX = -(x * zoomLevel - lensSize / 2);
          const bgY = -(y * zoomLevel - lensSize / 2);

          lens.style.backgroundImage = `url('${modalImage.src}')`;
          lens.style.backgroundSize = `${rect.width * zoomLevel}px ${rect.height * zoomLevel}px`;
          lens.style.backgroundPosition = `${bgX}px ${bgY}px`;
        });

        // Scroll to zoom - zooms from center of lens
        modalImage?.addEventListener(
          "wheel",
          (e: WheelEvent) => {
            if (!magnifyActive || !lens || !modalImage) return;

            e.preventDefault();

            const rect = modalImage.getBoundingClientRect();

            // Get current lens position
            const lensLeft = parseFloat(lens.style.left) || 0;
            const lensTop = parseFloat(lens.style.top) || 0;

            // Calculate center of lens relative to image
            const lensCenterX = lensLeft + lensSize / 2;
            const lensCenterY = lensTop + lensSize / 2;

            // Update zoom level
            const delta = e.deltaY > 0 ? -0.2 : 0.2;
            zoomLevel = Math.max(minZoom, Math.min(maxZoom, zoomLevel + delta));

            // Calculate new background position to keep center point stable
            const bgX = -(lensCenterX * zoomLevel - lensSize / 2);
            const bgY = -(lensCenterY * zoomLevel - lensSize / 2);

            lens.style.backgroundSize = `${rect.width * zoomLevel}px ${rect.height * zoomLevel}px`;
            lens.style.backgroundPosition = `${bgX}px ${bgY}px`;
          },
          { passive: false },
        );
      }
    });
  }

  // Initialize image enhancements
  enhanceBlogImages();
</script>
