---
import { formatDateCompact, formatWordCount } from "../lib/date";
import { getImage } from "astro:assets";

interface Props {
  title: string;
  description: string;
  date: Date;
  tags: string[];
  url: string;
  cover?: string | any;
  coverLight?: any;
  coverDark?: any;
  isExcalidrawCover?: boolean;
  draft?: boolean;
  index: number;
  wordCount: number;
}

const {
  title,
  description,
  date,
  tags,
  url,
  cover,
  coverLight,
  coverDark,
  isExcalidrawCover = false,
  draft = false,
  index,
  wordCount,
} = Astro.props;

// Helper function to get terminal color class based on index
function getTerminalColor(idx: number): string {
  const colors = ["ctp-teal", "ctp-mauve", "ctp-pink", "ctp-green"];
  return colors[idx % colors.length];
}

// Helper function to get icon for each blog post
function getPostIcon(idx: number): string {
  const icons = ["markdown", "readme", "git", "vim", "gnubash", "linux"];
  return icons[idx % icons.length];
}

// Helper function to get word count color based on count
function getWordCountColor(count: number): string {
  if (count < 500) return "text-ctp-blue";
  if (count < 1000) return "text-ctp-mauve";
  if (count < 2000) return "text-ctp-pink";
  if (count < 3000) return "text-ctp-peach";
  return "text-ctp-red";
}

// Helper function to generate Unix permissions based on index
function getPermissions(idx: number): {
  type: string;
  owner: string;
  group: string;
  other: string;
} {
  // File permissions for all posts (random but sane)
  const permissions = [
    { type: "-", owner: "rw-", group: "r--", other: "r--" }, // 644
    { type: "-", owner: "rwx", group: "r-x", other: "r-x" }, // 755
    { type: "-", owner: "rw-", group: "rw-", other: "r--" }, // 664
    { type: "-", owner: "rw-", group: "r--", other: "---" }, // 640
    { type: "-", owner: "rwx", group: "r-x", other: "--x" }, // 751
  ];
  return permissions[idx % permissions.length];
}

const colorClass = getTerminalColor(index);

// Map color classes to hex values for Simple Icons
const colorHexMap: Record<string, string> = {
  "ctp-teal": "94e2d5",
  "ctp-mauve": "cba6f7",
  "ctp-pink": "f5c2e7",
  "ctp-green": "a6e3a1",
};

const iconColor = colorHexMap[colorClass] || "94e2d5"; // default to teal

const isDraft = draft;
const permissions = getPermissions(index);
const formattedDate = formatDateCompact(date);
const wordCountFormatted = formatWordCount(wordCount);
const wordCountColor = getWordCountColor(wordCount);

// Extract banner URL - handle both string URLs and Astro Image objects
let coverUrl = "";
let coverLightUrl = "";
let coverDarkUrl = "";

if (typeof cover === "string") {
  coverUrl = cover;
} else if (cover) {
  const optimized = await getImage({ src: cover });
  coverUrl = optimized.src;
}

if (coverLight) {
  const optimized = await getImage({ src: coverLight });
  coverLightUrl = optimized.src;
}

if (coverDark) {
  const optimized = await getImage({ src: coverDark });
  coverDarkUrl = optimized.src;
}
---

<div class="group relative blog-post-item" data-tags={JSON.stringify(tags)}>
  <a
    href={url}
    class="post-link block py-1.5 md:py-1.5 py-2 px-3 md:px-4 -mx-3 md:-mx-4 rounded hover:bg-ctp-surface0 transition-all duration-200"
    data-post-title={title}
    data-post-description={description}
    data-post-cover={coverUrl}
    data-post-cover-light={coverLightUrl}
    data-post-cover-dark={coverDarkUrl}
    data-post-is-excalidraw={isExcalidrawCover}
    data-post-tags={JSON.stringify(tags)}
  >
    <!-- Desktop: Full ls -la style -->
    <div
      class="hidden md:grid grid-cols-[auto_auto_auto_auto_1fr] gap-4 items-center font-jetbrains"
    >
      <!-- Permissions (colored by section) -->
      <span class="text-base" style="letter-spacing: 0;"
        ><span
          class={permissions.type === "d"
            ? "text-ctp-blue"
            : "text-ctp-overlay1"}>{permissions.type}</span
        ><span class="text-ctp-yellow">{permissions.owner}</span><span
          class="text-ctp-green">{permissions.group}</span
        ><span class="text-ctp-teal">{permissions.other}</span></span
      >

      <!-- Owner -->
      <span class="text-ctp-yellow text-base"> milind </span>

      <!-- Word Count -->
      <span
        class={`${wordCountColor} whitespace-nowrap text-base font-semibold`}
      >
        {wordCountFormatted}
      </span>

      <!-- Date -->
      <span class="text-ctp-blue whitespace-nowrap text-base">
        {formattedDate}
      </span>

      <!-- File name with icon and badges -->
      <div class="flex items-center gap-3 min-w-0">
        <img
          src={`https://cdn.simpleicons.org/${getPostIcon(index)}/${iconColor}`}
          alt=""
          class="w-5 h-5 flex-shrink-0 opacity-80 blog-icon"
        />
        <span
          class={`text-ctp-text font-bold group-hover:underline decoration-${colorClass} transition-all text-base`}
        >
          {title}
        </span>
        {
          draft && (
            <span class="px-2 py-1 text-sm bg-ctp-yellow/20 text-ctp-yellow border border-ctp-yellow/50 rounded flex-shrink-0">
              draft
            </span>
          )
        }
      </div>
    </div>

    <!-- Mobile: Simplified style (date + icon + title) -->
    <div class="flex md:hidden items-start gap-3 font-jetbrains">
      <!-- Date -->
      <span
        class="text-ctp-blue whitespace-nowrap text-sm flex-shrink-0 pt-0.5"
      >
        {formattedDate}
      </span>

      <!-- Icon -->
      <img
        src={`https://cdn.simpleicons.org/${getPostIcon(index)}/${iconColor}`}
        alt=""
        class="w-4 h-4 flex-shrink-0 opacity-80 mt-0.5 blog-icon"
      />

      <!-- Title - wraps on multiple lines -->
      <span
        class={`text-ctp-text font-medium group-hover:underline decoration-${colorClass} transition-all text-sm break-words flex-1 min-w-0`}
      >
        {title}
      </span>

      {
        draft && (
          <span class="px-1.5 py-0.5 text-xs bg-ctp-yellow/20 text-ctp-yellow border border-ctp-yellow/50 rounded flex-shrink-0">
            draft
          </span>
        )
      }
    </div>
  </a>
</div>
