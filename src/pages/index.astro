---
import Layout from "../layouts/Layout.astro";
import { fetchGithubStats } from "../lib/github";
import { formatTimeAgo } from "../lib/date";
import TerminalPrompt from "../components/TerminalPrompt.astro";
import DiscordStatus from "../components/DiscordStatus";
import { personalInfo, experience, education } from "../data/portfolio";

import { SOCIAL_CONFIG, TERMINAL_CONFIG, BIRTH_DATE } from "../lib/constants";

const githubStats = await fetchGithubStats();
---

<Layout title="portfolio@milind.dev" includePadding={true}>
	<div
		id="terminal-container"
		class="font-mono text-xs sm:text-sm md:text-base leading-tight z-10 min-h-[100vh]"
	>
		<div class="mb-4">
			<TerminalPrompt
				user={TERMINAL_CONFIG.user}
				host={TERMINAL_CONFIG.host}
			>
				<span id="typewriter" class="text-ctp-text"></span><span
					id="cursor"
					class="text-ctp-text animate-pulse">█</span
				>
			</TerminalPrompt>
		</div>

		<div id="fetch-output" class="hidden">
			<div
				class="flex flex-col lg:flex-row gap-10 items-center lg:items-start w-fit"
			>
				<div class="select-none text-ctp-blue font-bold">
          <pre>
  ,=====================.
  |MILIND'S  LAB  /6000/|
  |.-------------------.|
  ||[ _ o     . .  _ ]_||
  |`-------------------'|
  ||                   ||
  |`-------------------'|
  ||                   ||
  |`-------------------'|
  ||                   ||
  |`-----------------_-'|
  ||[=========]| o  (@) |
  |`---------=='/u\ --- |
  |------_--------------|
  | (/) (_)           []|
  |---==--==----------==|
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  ||||||||||||||||||+×|||
  |||||||||||||||||||||||
  |=====================|
 .'                     `.
"""""""""""""""""""""""""""
          </pre>
				</div>

				<div class="flex flex-col gap-[2px]">
					<div class="mb-2">
						<span class="text-ctp-red">portfolio</span><span
							class="text-ctp-overlay2">@</span
						><span class="text-ctp-teal">milind.dev</span>
					</div>
					<div class="text-ctp-overlay1">
						--------------------------
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-md-map_marker"></i> Role</span
						>
						<span> : DevOps & Backend Engineer</span>
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-fa-building"></i> Work</span
						>
						<span> : {experience[0].company}</span>
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-md-school"></i> Education</span
						>
						<span> : {education[0].institution}</span>
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-md-briefcase"></i> Experience</span
						>
						<span> : 5 years, 4 clients, 8 projects</span>
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-md-file_document"></i> Articles</span
						>
						<span> : 2</span>
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-md-clock"></i> Uptime</span
						>
						<span> : </span><span id="uptime">Loading...</span>
					</div>

					<div class="text-ctp-overlay1">
						--------------------------
					</div>

					{
						personalInfo.social.map((social) => {
							if (social.name === "Github") return null;

							const config = SOCIAL_CONFIG[social.icon] || {
								icon: "nf-fa-link",
								color: "#cdd6f4", // text-ctp-text fallback
							};

							return (
								<div>
									<a
										href={social.url}
										target="_blank"
										class="hover:underline"
										style={{ color: config.color }}
									>
										<i class={`nf ${config.icon}`} />{" "}
										{social.name}
									</a>
								</div>
							);
						})
					}

					{
						githubStats && (
							<>
								<div class="text-ctp-overlay1">
									--------------------------
								</div>
								<div>
									<i class="nf nf-fa-github" /> Github Stats
									<span> : </span>
									<span>
										Repos: {githubStats.repos} | Followers:{" "}
										{githubStats.followers} | Following:{" "}
										{githubStats.following}
									</span>
								</div>
								{githubStats.lastPush && (
									<div>
										<span class="text-ctp-mauve">
											<i class="nf nf-oct-git_commit" />{" "}
											Last Commit
										</span>
										<span> : </span>
										<a
											href={
												"https://github.com/" +
												githubStats.lastPush.repo
											}
											target="_blank"
											class="text-ctp-text hover:underline"
										>
											<span>
												{githubStats.lastPush.repo} -{" "}
												{formatTimeAgo(
													githubStats.lastPush.at,
												)}
											</span>
										</a>
									</div>
								)}
							</>
						)
					}

					<div>
						<DiscordStatus
							client:load
							userId={import.meta.env.DISCORD_USER_ID}
							socketUrl={import.meta.env.LANYARD_SOCKET_URL}
						/>
					</div>
					<div class="text-ctp-overlay1">
						--------------------------
					</div>
					<div class="mt-2 flex gap-3 select-none">
						<span class="w-3 h-3 rounded-full bg-ctp-black"></span>
						<span class="w-3 h-3 rounded-full bg-ctp-red"></span>
						<span class="w-3 h-3 rounded-full bg-ctp-green"></span>
						<span class="w-3 h-3 rounded-full bg-ctp-yellow"></span>
						<span class="w-3 h-3 rounded-full bg-ctp-blue"></span>
						<span class="w-3 h-3 rounded-full bg-ctp-mauve"></span>
						<span class="w-3 h-3 rounded-full bg-ctp-teal"></span>
						<span class="w-3 h-3 rounded-full bg-ctp-text"></span>
					</div>
				</div>
			</div>

			<div class="mt-4"></div>
		</div>
	</div>

	<script define:vars={{ BIRTH_DATE }}>
		// Typewriter animation
		const text = "fastfetch";
		const typewriter = document.getElementById("typewriter");
		const fetchOutput = document.getElementById("fetch-output");
		const cursor = document.getElementById("cursor");
		let i = 0;

		function type() {
			if (i < text.length) {
				if (typewriter) typewriter.textContent += text.charAt(i);
				i++;
				setTimeout(type, 50 + Math.random() * 50);
			} else {
				// Determine if we should wait for Lanyard
				let isReady = false;
				const showOutput = () => {
					if (fetchOutput) fetchOutput.classList.remove("hidden");
					if (cursor) cursor.style.display = "none";
				};

				const onReady = () => {
					if (!isReady) {
						isReady = true;
						showOutput();
					}
				};

				window.addEventListener("lanyard-ready", onReady);

				// Fallback timeout in case Lanyard fails or is slow (2s max wait after typing)
				setTimeout(() => {
					if (!isReady) {
						isReady = true;
						showOutput();
						// Remove listener if we timed out to avoid double call (though flag handles it)
						window.removeEventListener("lanyard-ready", onReady);
					}
				}, 2000);
			}
		}

		// Start typing after a short delay
		setTimeout(type, 200);

		// Uptime Logic
		function updateUptime() {
			const birthDate = new Date(BIRTH_DATE);
			const now = new Date();

			let years = now.getFullYear() - birthDate.getFullYear();
			let months = now.getMonth() - birthDate.getMonth();
			let days = now.getDate() - birthDate.getDate();

			if (days < 0) {
				months--;
				// Get days in previous month
				const prevMonth = new Date(
					now.getFullYear(),
					now.getMonth(),
					0,
				);
				days += prevMonth.getDate();
			}

			if (months < 0) {
				years--;
				months += 12;
			}

			const uptimeElement = document.getElementById("uptime");
			if (uptimeElement) {
				uptimeElement.textContent = `${years} years, ${months} months, ${days} days`;
			}
		}

		setInterval(updateUptime, 86400000);
		updateUptime();
	</script>
</Layout>
