---
import Layout from "../layouts/Layout.astro";
import { fetchGithubStats } from "../lib/github";
import { formatTimeAgo } from "../lib/date";
import TerminalPrompt from "../components/TerminalPrompt.astro";
import DiscordStatus from "../components/DiscordStatus";
import SocialIcons from "../components/SocialIcons.astro";
import { personalInfo, experience, education } from "../lib/constants";

import { SOCIAL_CONFIG, TERMINAL_CONFIG, BIRTH_DATE } from "../lib/constants";
import { getBlogPosts } from "../lib/blog";

const githubStats = await fetchGithubStats();
const posts = getBlogPosts();
const latestPost = posts.length > 0 ? posts[0] : null;
---

<Layout title="portfolio@milind.dev" includePadding={true}>
	<div
		id="terminal-container"
		class="font-mono text-sm sm:text-base md:text-lg lg:text-xl xl:text-2xl leading-tight z-10 min-h-[100vh] lg:min-h-0 lg:h-[calc(100vh-4rem)] lg:overflow-hidden"
	>
		<div class="mb-4">
			<TerminalPrompt
				user={TERMINAL_CONFIG.user}
				host={TERMINAL_CONFIG.host}
			>
				<span id="typewriter" class="text-ctp-text"></span><span
					id="cursor"
					class="text-ctp-text animate-pulse">█</span
				>
			</TerminalPrompt>
		</div>

		<div id="fetch-output" class="hidden">
			<div
				class="flex flex-col lg:flex-row gap-10 items-center lg:items-start w-fit"
			>
				<div class="select-none text-ctp-blue font-bold">
					<pre
						class="hidden lg:block">
  ,=====================.
  |MILIND'S  LAB  /6000/|
  |.-------------------.|
  ||[ _ o     . .  _ ]_||
  |`-------------------'|
  ||                   ||
  |`-------------------'|
  ||                   ||
  |`-------------------'|
  ||                   ||
  |`-----------------_-'|
  ||[=========]| o  (@) |
  |`---------=='/u\ --- |
  |------_--------------|
  | (/) (_)           []|
  |---==--==----------==|
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  |||||||||||||||||||||||
  ||||||||||||||||||+×|||
  |||||||||||||||||||||||
  |=====================|
 .'                     `.
"""""""""""""""""""""""""""
          </pre>
					<pre
						class="block lg:hidden">
   +--------------+
   |.------------.|
   ||            ||
   ||   HELLO    ||
   ||    WORLD   ||
   ||            ||
   |+------------+|
   +-..--------..-+
   .--------------.
  / /============\ \
 / /==============\ \
/____________________\
\____________________/
          </pre>
				</div>

				<div class="flex flex-col gap-[2px]">
					<div class="mb-2">
						<span class="text-ctp-red">portfolio</span><span
							class="text-ctp-overlay2">@</span
						><span class="text-ctp-teal">milind.dev</span>
					</div>
					<div class="text-ctp-overlay1">
						--------------------------
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-md-map_marker"></i> Role</span
						>
						<span> : DevOps & Backend Engineer</span>
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-fa-building"></i> Work</span
						>
						<span> : {experience[0].company}</span>
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-md-school"></i> Education</span
						>
						<span> : {education[0].institution}</span>
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-md-briefcase"></i> Experience</span
						>
						<span> : 5 years, 4 clients, 8 projects</span>
					</div>
					<div>
						<span class="text-ctp-blue"
							><i class="nf nf-md-clock"></i> Uptime</span
						>
						<span> : </span><span id="uptime">Loading...</span>
					</div>
					<div>
						<a
							href="/blog"
							class="group flex items-center gap-2 animate-gold-pulse -ml-2 px-2 rounded w-fit"
						>
							<span
								class="text-ctp-yellow font-bold group-hover:text-ctp-teal transition-colors"
								><i class="nf nf-md-file_document"></i> Blog</span
							>
							<span class="text-ctp-overlay2">::</span>
							<span
								class="text-ctp-text group-hover:underline decoration-ctp-yellow underline-offset-4"
								>{posts.length} articles</span
							>
							<span
								class="text-xs text-ctp-overlay0 opacity-0 group-hover:opacity-100 transition-opacity"
								>[READ]</span
							>
						</a>
					</div>
					{
						latestPost && (
							<div>
								<span class="text-ctp-mauve">
									<i class="nf nf-fa-pen_nib" /> Latest Post
								</span>
								<span> : </span>
								<a
									href={latestPost.url}
									class="text-ctp-text hover:underline hover:text-ctp-teal transition-colors"
								>
									{latestPost.title}
								</a>
							</div>
						)
					}

					{
						githubStats && (
							<>
								<div class="text-ctp-overlay1">
									--------------------------
								</div>
								<div>
									<i class="nf nf-fa-github" /> Github Stats
									<span> : </span>
									<span>
										Repos: {githubStats.repos} | Followers:{" "}
										{githubStats.followers} | Following:{" "}
										{githubStats.following}
									</span>
								</div>
								{githubStats.lastPush && (
									<div>
										<span class="text-ctp-mauve">
											<i class="nf nf-oct-git_commit" />{" "}
											Last Commit
										</span>
										<span> : </span>
										<a
											href={
												"https://github.com/" +
												githubStats.lastPush.repo
											}
											target="_blank"
											class="text-ctp-text hover:underline"
										>
											<span>
												{githubStats.lastPush.repo} -{" "}
												{formatTimeAgo(
													githubStats.lastPush.at,
												)}
											</span>
										</a>
									</div>
								)}
							</>
						)
					}

					<div>
						<DiscordStatus
							client:load
							userId={import.meta.env.DISCORD_USER_ID}
							socketUrl={import.meta.env.LANYARD_SOCKET_URL}
						/>
					</div>
					<div class="text-ctp-overlay1">
						--------------------------
					</div>
					<div class="mt-4 mb-2">
						<SocialIcons
							size="w-10 h-10 lg:w-12 lg:h-12"
							iconSize="text-lg lg:text-xl"
							gap="gap-3"
							showRss={false}
						/>
					</div>
				</div>
			</div>

			<div class="mt-4"></div>
		</div>
	</div>

	<script define:vars={{ BIRTH_DATE }}>
		// Typewriter animation
		const text = "fastfetch";
		const typewriter = document.getElementById("typewriter");
		const fetchOutput = document.getElementById("fetch-output");
		const cursor = document.getElementById("cursor");
		let i = 0;

		function type() {
			if (i < text.length) {
				if (typewriter) typewriter.textContent += text.charAt(i);
				i++;
				setTimeout(type, 50 + Math.random() * 50);
			} else {
				// Determine if we should wait for Lanyard
				let isReady = false;
				const showOutput = () => {
					if (fetchOutput) fetchOutput.classList.remove("hidden");
					if (cursor) cursor.style.display = "none";
				};

				const onReady = () => {
					if (!isReady) {
						isReady = true;
						showOutput();
					}
				};

				window.addEventListener("lanyard-ready", onReady);

				// Fallback timeout in case Lanyard fails or is slow (2s max wait after typing)
				setTimeout(() => {
					if (!isReady) {
						isReady = true;
						showOutput();
						// Remove listener if we timed out to avoid double call (though flag handles it)
						window.removeEventListener("lanyard-ready", onReady);
					}
				}, 2000);
			}
		}

		// Start typing after a short delay
		setTimeout(type, 200);

		// Uptime Logic
		function updateUptime() {
			const birthDate = new Date(BIRTH_DATE);
			const now = new Date();

			let years = now.getFullYear() - birthDate.getFullYear();
			let months = now.getMonth() - birthDate.getMonth();
			let days = now.getDate() - birthDate.getDate();

			if (days < 0) {
				months--;
				// Get days in previous month
				const prevMonth = new Date(
					now.getFullYear(),
					now.getMonth(),
					0,
				);
				days += prevMonth.getDate();
			}

			if (months < 0) {
				years--;
				months += 12;
			}

			const uptimeElement = document.getElementById("uptime");
			if (uptimeElement) {
				uptimeElement.textContent = `${years} years, ${months} months, ${days} days`;
			}
		}

		setInterval(updateUptime, 86400000);
		updateUptime();
	</script>
</Layout>

<style>
	@keyframes gold-pulse {
		0%,
		100% {
			background-color: transparent;
			box-shadow: none;
		}
		50% {
			background-color: rgba(249, 226, 175, 0.1);
			box-shadow: 0 0 8px rgba(249, 226, 175, 0.4);
		}
	}

	.animate-gold-pulse {
		animation: gold-pulse 3s infinite ease-in-out;
	}
</style>
