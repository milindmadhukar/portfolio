---
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';

// Get all blog posts from the file system using import.meta.glob
const allPosts = import.meta.glob('./**/index.md', { eager: true });

// Convert glob result to array format
const blogPosts: any[] = Object.entries(allPosts).map(([path, module]: [string, any]) => {
  // Extract slug from path
  const pathParts = path.split('/');
  const slug = pathParts[pathParts.length - 2];
  
  return {
    ...module,
    url: `/blog/${slug}/`,
    slug,
  };
});

// Filter out template folders and drafts based on frontmatter
const isDevelopment = import.meta.env.DEV;
const publishedPosts = blogPosts.filter((post) => {
  const { slug } = post;
  
  // Exclude template folders (starting with _) and hidden folders (starting with .)
  if (slug && (slug.startsWith('_') || slug.startsWith('.'))) {
    return false;
  }
  
  // In development, show drafts; in production, exclude them
  if (!isDevelopment && post.frontmatter?.draft === true) {
    return false;
  }
  
  return true;
});

// Process and sort posts by date
const images = import.meta.glob<{ default: ImageMetadata }>('./**/_assets/*.{png,jpg,jpeg,gif,webp,svg}', { eager: true });

const posts = publishedPosts.map((post) => {
  const frontmatter = post.frontmatter || {};
  const { slug } = post;
  
  // Handle banner image if it exists (supports both local Obsidian paths and URLs)
  let bannerImage: any = null;
  if (frontmatter.banner) {
    // Check if it's a URL (starts with http:// or https://)
    if (frontmatter.banner.startsWith('http://') || frontmatter.banner.startsWith('https://')) {
      bannerImage = frontmatter.banner;
    } else {
      // Handle local Obsidian path (e.g., ./garrix.png or _assets/garrix.png)
      const bannerPath = frontmatter.banner.startsWith('./') 
        ? `./${slug}/_assets/${frontmatter.banner.slice(2)}`
        : `./${slug}/_assets/${frontmatter.banner}`;
      const localImage = images[bannerPath];
      if (localImage) {
        bannerImage = localImage.default;
      } else {
        console.warn(`Banner image not found for ${slug}:`, frontmatter.banner);
      }
    }
  }
  
  return {
    url: post.url,
    slug,
    title: frontmatter.title || 'Untitled',
    description: frontmatter.description || '',
    date: frontmatter.date ? new Date(frontmatter.date) : new Date(),
    tags: (frontmatter.tags || []) as string[],
    cover: bannerImage,
    draft: frontmatter.draft || false,
  };
});

// Sort by date (newest first)
posts.sort((a, b) => b.date.getTime() - a.date.getTime());

// Get all unique tags from all posts
const allTags = [...new Set(posts.flatMap(post => post.tags))].sort();

// Helper function to format date like ls -la (e.g., "Sunday, 23 November 2025, 10:52")
function formatLsDate(date: Date): string {
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  
  const dayName = days[date.getDay()];
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${dayName}, ${day} ${month} ${year}, ${hours}:${minutes}`;
}

// Helper function to get terminal color class based on index
function getTerminalColor(index: number): string {
  const colors = ['terminal-blue', 'terminal-green', 'cyber-cyan', 'cyber-purple'];
  return colors[index % colors.length];
}

// Helper function to get icon for each blog post
function getPostIcon(index: number): string {
  const icons = ['markdown', 'readme', 'git', 'vim', 'gnubash', 'linux'];
  return icons[index % icons.length];
}
---

<Layout title="Blog - Milind Madhukar">
  <div class="min-h-screen py-20 px-6">
    <div class="max-w-6xl mx-auto">
      <!-- Terminal Header -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-8">
          <a
            href="/"
            class="group flex items-center gap-2 text-[var(--text-tertiary)] hover:text-cyber-cyan transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="text-sm font-medium">Back to Home</span>
          </a>
        </div>


        <h1 class="text-5xl md:text-7xl font-black mb-4">
          <span class="cyber-text">My Thoughts</span><span class="vim-cursor ml-2"></span>
        </h1>

        <!-- RSS Feed Link -->
        <div class="mb-6">
          <a
            href="/blog/rss.xml"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-4 py-2 bg-neon-orange/10 border border-neon-orange/30 rounded-lg text-neon-orange hover:bg-neon-orange/20 transition-all hover-glow"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"/>
            </svg>
            <span class="font-medium text-sm">Subscribe via RSS</span>
          </a>
        </div>


        <div class="mb-6">
          <p class="text-lg font-mono text-[var(--text-secondary)] mb-2">
            <span class="text-terminal-green">milind@thoughts</span>:<span class="text-terminal-blue">~/blog</span>$ ls -la
          </p>
        </div>


        <!-- Tags Filter -->
        {allTags.length > 0 && (
          <div class="mb-8">
            <div class="flex items-center gap-3 mb-3">
              <span class="text-sm font-mono text-[var(--text-tertiary)]">
                Filter by tag:
              </span>
            </div>
            <div class="flex flex-wrap gap-2">
              <button
                class="tag-filter-btn px-3 py-1 text-sm font-mono bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded hover:border-cyber-cyan transition-all active"
                data-tag="all"
              >
                all
              </button>
              {allTags.map((tag: string) => (
                <button
                  class="tag-filter-btn px-3 py-1 text-sm font-mono bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded hover:border-cyber-cyan transition-all"
                  data-tag={tag}
                >
                  #{tag}
                </button>
              ))}
            </div>
          </div>
        )}

      </div>

      {posts.length === 0 ? (
        <div class="font-mono text-sm text-[var(--text-tertiary)] py-8">
          <p>total 0</p>
          <p class="mt-4">$ echo "No posts yet... Coming soon!"</p>
        </div>
      ) : (
        <div class="font-mono text-sm">
          <!-- Total line (like ls -la shows) -->
          <div class="text-[var(--text-tertiary)] mb-4 posts-total">
            total {posts.length}
          </div>

          <!-- Blog posts as ls -la entries -->
          <div class="space-y-1">
            {posts.map((post, index) => {
              const colorClass = getTerminalColor(index);
              const permissions = post.draft ? '-rw-r--r--' : '-rwxr-xr-x';
              const formattedDate = formatLsDate(post.date);
              
              return (
                <div class="group relative blog-post-item" data-tags={JSON.stringify(post.tags)}>
                  <a
                    href={post.url}
                    class="block py-2 px-3 -mx-3 rounded hover:bg-[var(--bg-elevated)] transition-all duration-200"
                  >
                    <div class="grid grid-cols-[auto_auto_auto_auto_1fr] gap-3 items-center">
                      <!-- Permissions -->
                      <span class="text-[var(--text-tertiary)]">
                        {permissions}
                      </span>

                      <!-- Owner -->
                      <span class="text-[var(--text-tertiary)]">
                        milind
                      </span>

                      <!-- Group -->
                      <span class="text-[var(--text-tertiary)]">
                        milind
                      </span>

                      <!-- Date -->
                      <span class="text-[var(--text-tertiary)] whitespace-nowrap">
                        {formattedDate}
                      </span>

                      <!-- File name with icon and badges -->
                      <div class="flex items-center gap-2 min-w-0">
                        <img 
                          src={`https://cdn.simpleicons.org/${getPostIcon(index)}`}
                          alt=""
                          class="w-4 h-4 flex-shrink-0 opacity-80"
                          style="filter: brightness(0) saturate(100%) invert(68%) sepia(77%) saturate(385%) hue-rotate(95deg) brightness(95%) contrast(91%);"
                        />
                        <span class={`text-${colorClass} font-semibold group-hover:underline decoration-${colorClass}/50 transition-all truncate`}>
                          {post.title}
                        </span>
                        {post.draft && (
                          <span class="px-2 py-0.5 text-xs bg-terminal-yellow/20 text-terminal-yellow border border-terminal-yellow/50 rounded flex-shrink-0">
                            draft
                          </span>
                        )}
                      </div>
                    </div>
                  </a>

                  <!-- Hover preview card -->
                  {(post.description || post.cover) && (
                    <div class="absolute left-full ml-8 top-0 w-96 p-4 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50 pointer-events-none hidden xl:block">
                      {post.cover && (
                        <div class="mb-3 rounded-lg overflow-hidden border border-[var(--border-color)]">
                          {typeof post.cover === 'string' ? (
                            <img 
                              src={post.cover} 
                              alt={post.title}
                              class="w-full h-40 object-cover"
                            />
                          ) : (
                            <Image
                              src={post.cover}
                              alt={post.title}
                              width={400}
                              height={200}
                              class="w-full h-40 object-cover"
                            />
                          )}
                        </div>
                      )}
                      {post.description && (
                        <p class="text-sm text-[var(--text-secondary)] leading-relaxed">
                          {post.description}
                        </p>
                      )}
                      {post.tags.length > 0 && (
                        <div class="flex flex-wrap gap-1 mt-3 pt-3 border-t border-[var(--border-color)]">
                          {post.tags.map((tag: string) => (
                            <span class="text-xs px-2 py-0.5 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded text-[var(--text-tertiary)]">
                              #{tag}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          <!-- Terminal footer -->
          <div class="mt-8 pt-6 border-t border-[var(--border-color)] text-[var(--text-tertiary)]">
            <p>
              <span class="text-terminal-green">$</span> Found {posts.length} {posts.length === 1 ? 'post' : 'posts'}
            </p>
          </div>
        </div>
      )}
    </div>
  </div>
</Layout>

<style>
  /* Terminal listing styles */
  a:hover .text-terminal-blue,
  a:hover .text-terminal-green,
  a:hover .text-cyber-cyan,
  a:hover .text-cyber-purple {
    filter: brightness(1.3);
  }

  /* Tag filter active state */
  .tag-filter-btn.active {
    background: var(--color-cyber-cyan);
    background-opacity: 0.2;
    border-color: var(--color-cyber-cyan);
    color: var(--color-cyber-cyan);
  }

  /* Hidden posts */
  .blog-post-item.hidden {
    display: none;
  }
</style>

<script>
  // Tag filtering functionality
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.tag-filter-btn');
    const blogPosts = document.querySelectorAll('.blog-post-item');
    const totalElement = document.querySelector('.posts-total');

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const selectedTag = button.getAttribute('data-tag');

        // Update active button state
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        // Filter posts
        let visibleCount = 0;
        blogPosts.forEach(post => {
          const postTags = JSON.parse(post.getAttribute('data-tags') || '[]');
          
          if (selectedTag === 'all' || postTags.includes(selectedTag)) {
            post.classList.remove('hidden');
            visibleCount++;
          } else {
            post.classList.add('hidden');
          }
        });

        // Update total count
        if (totalElement) {
          totalElement.textContent = `total ${visibleCount}`;
        }
      });
    });
  });
</script>
