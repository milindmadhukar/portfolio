---
import Layout from '../../layouts/Layout.astro';
import BlogPostItem from '../../components/BlogPostItem.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import { Image } from 'astro:assets';

// Get all blog posts from the file system using import.meta.glob
const allPosts = import.meta.glob('./**/index.md', { eager: true });

// Convert glob result to array format
const blogPosts: any[] = Object.entries(allPosts).map(([path, module]: [string, any]) => {
  // Extract slug from path
  const pathParts = path.split('/');
  const slug = pathParts[pathParts.length - 2];
  
  return {
    ...module,
    url: `/blog/${slug}/`,
    slug,
  };
});

// Filter out template folders and drafts based on frontmatter
const isDevelopment = import.meta.env.DEV;
const publishedPosts = blogPosts.filter((post) => {
  const { slug } = post;
  
  // Exclude template folders (starting with _) and hidden folders (starting with .)
  if (slug && (slug.startsWith('_') || slug.startsWith('.'))) {
    return false;
  }
  
  // In development, show drafts; in production, exclude them
  if (!isDevelopment && post.frontmatter?.draft === true) {
    return false;
  }
  
  return true;
});

// Process and sort posts by date
const images = import.meta.glob<{ default: ImageMetadata }>('./**/_assets/*.{png,jpg,jpeg,gif,webp,svg}', { eager: true });

const posts = publishedPosts.map((post) => {
  const frontmatter = post.frontmatter || {};
  const { slug } = post;
  
  // Handle banner image if it exists (supports both local Obsidian paths and URLs)
  let bannerImage: any = null;
  if (frontmatter.banner) {
    // Check if it's a URL (starts with http:// or https://)
    if (frontmatter.banner.startsWith('http://') || frontmatter.banner.startsWith('https://')) {
      bannerImage = frontmatter.banner;
    } else {
      // Handle local Obsidian path (e.g., ./garrix.png or _assets/garrix.png)
      const bannerPath = frontmatter.banner.startsWith('./') 
        ? `./${slug}/_assets/${frontmatter.banner.slice(2)}`
        : `./${slug}/_assets/${frontmatter.banner}`;
      const localImage = images[bannerPath];
      if (localImage) {
        bannerImage = localImage.default;
      } else {
        console.warn(`Banner image not found for ${slug}:`, frontmatter.banner);
      }
    }
  }
  
  return {
    url: post.url,
    slug,
    title: frontmatter.title || 'Untitled',
    description: frontmatter.description || '',
    date: frontmatter.date ? new Date(frontmatter.date) : new Date(),
    tags: (frontmatter.tags || []) as string[],
    cover: bannerImage,
    draft: frontmatter.draft || false,
  };
});

// Sort by date (newest first)
posts.sort((a, b) => b.date.getTime() - a.date.getTime());

// Get all unique tags from all posts
const allTags = [...new Set(posts.flatMap(post => post.tags))].sort();
---

<Layout title="Blog - Milind Madhukar">
  <div class="min-h-screen py-20 px-6">
    <div class="max-w-6xl mx-auto">
      <!-- Terminal Header -->
      <div class="mt-8 mb-4">
        <div class="flex items-center gap-3 mb-8">
          <a
            href="/"
            class="group flex items-center gap-2 text-[var(--text-tertiary)] hover:text-cyber-cyan transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="text-sm font-medium">Back to Home</span>
          </a>
        </div>


        <h1 class="text-4xl sm:text-5xl md:text-7xl font-black mb-4 pb-2 flex items-baseline whitespace-nowrap">
          <span class="text-[var(--text-primary)] inline-block">My Thoughts</span><span class="vim-cursor ml-1 sm:ml-2 inline-block"></span>
        </h1>

        <!-- RSS Feed Link -->
        <div class="mb-6">
          <a
            href="/blog/rss.xml"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-4 py-2 bg-neon-orange/10 border border-neon-orange/30 rounded-lg text-neon-orange hover:bg-neon-orange/20 transition-all"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"/>
            </svg>
            <span class="font-medium text-sm">Subscribe via RSS</span>
          </a>
        </div>


        <!-- Tags Filter (above terminal) -->
        <!-- Tags Filter (all devices) -->
        {allTags.length > 0 && (
          <div class="mb-6">
            <div class="flex items-center gap-3 mb-4">
              <span class="text-sm font-mono text-[var(--text-tertiary)]">
                <span class="text-terminal-green hidden md:inline">$</span> <span class="hidden md:inline">filter:</span><span class="md:hidden">Filter by tag:</span>
              </span>
            </div>
            <div class="flex flex-wrap gap-2">
              <button
                class="tag-filter-btn px-3 py-1 text-sm font-mono bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded hover:border-cyber-cyan transition-all active"
                data-tag="all"
              >
                all
              </button>
              {allTags.map((tag: string) => (
                <button
                  class="tag-filter-btn px-3 py-1 text-sm font-mono bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded hover:border-cyber-cyan transition-all"
                  data-tag={tag}
                >
                  #{tag}
                </button>
              ))}
            </div>
          </div>
        )}

        <div class="mb-1 hidden md:block">
          <p class="text-lg font-mono text-[var(--text-secondary)] mb-1.5">
            <span class="text-terminal-green">milind@thoughts</span>:<span class="text-terminal-blue">~/blog</span>$ <span class="terminal-command"></span><span class="terminal-pipe"></span><span class="terminal-cursor">â–ˆ</span>
          </p>
        </div>

      </div>

      {posts.length === 0 ? (
        <div class="font-mono text-sm text-[var(--text-tertiary)]">
          <p>total 0</p>
          <p class="mt-2">$ echo "No posts yet... Coming soon!"</p>
        </div>
      ) : (
        <div>
            <!-- Desktop: ls -la style -->
          <div class="font-mono text-base hidden md:block ls-output" style="opacity: 0;">
            <!-- Total line (like ls -la shows) -->
            <div class="text-[var(--text-tertiary)] posts-total text-base">
              total {posts.length}
            </div>

            <!-- Blog posts as ls -la entries -->
            <div class="space-y-0.5">
              {posts.map((post, index) => (
                <BlogPostItem
                  title={post.title}
                  description={post.description}
                  date={post.date}
                  tags={post.tags}
                  url={post.url}
                  cover={post.cover}
                  draft={post.draft}
                  index={index}
                />
              ))}
            </div>
          </div>

          <!-- Cursor-following hover card (desktop only) -->
          <div id="hover-card" class="fixed w-96 p-4 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-lg shadow-2xl opacity-0 invisible transition-opacity duration-200 z-50 pointer-events-none hidden md:block" style="left: 0; top: 0;">
            <div id="hover-card-cover" class="mb-3 rounded-lg overflow-hidden border border-[var(--border-color)] hidden">
              <img id="hover-card-image" src="" alt="" class="w-full h-40 object-cover" />
            </div>
            <p id="hover-card-description" class="text-sm text-[var(--text-secondary)] leading-relaxed"></p>
            <div id="hover-card-tags" class="flex flex-wrap gap-1 mt-3 pt-3 border-t border-[var(--border-color)]"></div>
          </div>

          <!-- Mobile: Card style -->
          <div class="md:hidden space-y-4 mobile-cards" style="opacity: 0;">
            {posts.map((post, index) => (
              <BlogPostCard
                title={post.title}
                description={post.description}
                date={post.date}
                tags={post.tags}
                url={post.url}
                cover={post.cover}
                draft={post.draft}
                index={index}
              />
            ))}

            <!-- Mobile footer -->
            <div class="mt-6 pt-4 border-t border-[var(--border-color)] text-[var(--text-tertiary)] text-sm font-mono text-center posts-total-mobile">
              {posts.length} {posts.length === 1 ? 'post' : 'posts'}
            </div>
          </div>
        </div>
      )}
    </div>
  </div>
</Layout>

<style>
  /* Terminal listing styles */
  a:hover .text-terminal-blue,
  a:hover .text-terminal-green,
  a:hover .text-cyber-cyan,
  a:hover .text-cyber-purple {
    filter: brightness(1.3);
  }

  /* Tag filter active state */
  .tag-filter-btn.active {
    background: oklch(0.75 0.18 195 / 0.15);
    border-color: var(--color-cyber-cyan);
    color: var(--color-cyber-cyan);
  }

  /* Hidden posts */
  .blog-post-item.hidden {
    display: none;
  }

  /* Terminal cursor blink */
  .terminal-cursor {
    animation: blink 1s step-end infinite;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  /* Fade in animations */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes instantShow {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .ls-output.animate-in {
    animation: instantShow 0.1s ease-out forwards;
  }

  .mobile-cards.animate-in {
    animation: fadeIn 0.6s ease-out forwards;
  }
</style>

<script>
  // Typing animation for ls -la command
  document.addEventListener('DOMContentLoaded', () => {
    const commandElement = document.querySelector('.terminal-command') as HTMLElement | null;
    const cursorElement = document.querySelector('.terminal-cursor') as HTMLElement | null;
    const lsOutput = document.querySelector('.ls-output') as HTMLElement | null;
    const mobileCards = document.querySelector('.mobile-cards') as HTMLElement | null;
    const command = 'ls -la';
    let charIndex = 0;

    // Type out the command character by character
    function typeCommand() {
      if (commandElement && charIndex < command.length) {
        commandElement.textContent = command.slice(0, charIndex + 1);
        charIndex++;
        setTimeout(typeCommand, 100); // 100ms per character
      } else {
        // Command typing complete, hide cursor and show output
        setTimeout(() => {
          if (cursorElement) {
            cursorElement.style.display = 'none';
          }
          
          // Show ls output with instant animation
          if (lsOutput) {
            lsOutput.classList.add('animate-in');
          }

          // Show mobile cards with fade-in animation
          if (mobileCards) {
            mobileCards.classList.add('animate-in');
          }
        }, 200);
      }
    }

    // Start typing animation
    if (commandElement) {
      setTimeout(typeCommand, 500); // Start after 500ms delay
    } else {
      // If no command element (mobile), just fade in the cards
      if (mobileCards) {
        setTimeout(() => {
          mobileCards.classList.add('animate-in');
        }, 300);
      }
    }

    // Tag filtering functionality
    const filterButtons = document.querySelectorAll('.tag-filter-btn');
    const blogPosts = document.querySelectorAll('.blog-post-item');
    const totalElement = document.querySelector('.posts-total') as HTMLElement | null;
    const totalMobileElement = document.querySelector('.posts-total-mobile') as HTMLElement | null;
    const pipeElement = document.querySelector('.terminal-pipe') as HTMLElement | null;

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const selectedTag = button.getAttribute('data-tag');

        // Update active button state
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        // Update the command to show grep pipe
        if (pipeElement) {
          if (selectedTag === 'all') {
            pipeElement.textContent = '';
          } else {
            pipeElement.textContent = ` | grep "tag=${selectedTag}"`;
            pipeElement.style.color = 'var(--color-terminal-yellow)';
          }
        }

        // Filter posts - count only unique posts (desktop version only)
        let visibleCount = 0;
        
        blogPosts.forEach((post, index) => {
          const postTags = JSON.parse(post.getAttribute('data-tags') || '[]');
          const postElement = post as HTMLElement;
          
          if (selectedTag === 'all' || postTags.includes(selectedTag)) {
            postElement.classList.remove('hidden');
            // Only count desktop posts (first half of the array, since posts are duplicated for mobile)
            if (index < blogPosts.length / 2) {
              visibleCount++;
            }
          } else {
            postElement.classList.add('hidden');
          }
        });

        // Update total count for desktop
        if (totalElement) {
          totalElement.textContent = `total ${visibleCount}`;
        }

        // Update found posts count
        if (postsCountElement) {
          postsCountElement.textContent = visibleCount.toString();
        }
        if (postsLabelElement) {
          postsLabelElement.textContent = visibleCount === 1 ? 'post' : 'posts';
        }

        // Update total count for mobile
        if (totalMobileElement) {
          totalMobileElement.textContent = `${visibleCount} ${visibleCount === 1 ? 'post' : 'posts'}`;
        }
      });
    });

    // Cursor-following hover card functionality
    const hoverCard = document.getElementById('hover-card') as HTMLElement | null;
    const hoverCardCover = document.getElementById('hover-card-cover') as HTMLElement | null;
    const hoverCardImage = document.getElementById('hover-card-image') as HTMLImageElement | null;
    const hoverCardDescription = document.getElementById('hover-card-description') as HTMLElement | null;
    const hoverCardTags = document.getElementById('hover-card-tags') as HTMLElement | null;
    const postLinks = document.querySelectorAll('.post-link');

    let currentMouseX = 0;
    let currentMouseY = 0;

    // Track mouse position
    document.addEventListener('mousemove', (e) => {
      currentMouseX = e.clientX;
      currentMouseY = e.clientY;

      if (hoverCard && hoverCard.classList.contains('opacity-100')) {
        // Position card near cursor with offset
        const cardWidth = 384; // w-96 = 384px
        const cardHeight = hoverCard.offsetHeight;
        const offset = 20;

        let left = currentMouseX + offset;
        let top = currentMouseY + offset;

        // Check if card goes off right edge
        if (left + cardWidth > window.innerWidth) {
          left = currentMouseX - cardWidth - offset;
        }

        // Check if card goes off bottom edge
        if (top + cardHeight > window.innerHeight) {
          top = currentMouseY - cardHeight - offset;
        }

        // Check if card goes off top edge
        if (top < 0) {
          top = offset;
        }

        // Check if card goes off left edge
        if (left < 0) {
          left = offset;
        }

        hoverCard.style.left = `${left}px`;
        hoverCard.style.top = `${top}px`;
      }
    });

    postLinks.forEach(link => {
      link.addEventListener('mouseenter', (e) => {
        const target = e.currentTarget as HTMLElement;
        const cover = target.getAttribute('data-post-cover');
        const description = target.getAttribute('data-post-description');
        const tagsStr = target.getAttribute('data-post-tags');

        if (!hoverCard || !hoverCardDescription || !hoverCardTags) return;

        // Populate hover card
        if (cover && cover !== '' && hoverCardCover && hoverCardImage) {
          hoverCardImage.src = cover;
          hoverCardCover.classList.remove('hidden');
        } else if (hoverCardCover) {
          hoverCardCover.classList.add('hidden');
        }

        if (description && hoverCardDescription) {
          hoverCardDescription.textContent = description;
          hoverCardDescription.classList.remove('hidden');
        } else if (hoverCardDescription) {
          hoverCardDescription.classList.add('hidden');
        }

        // Populate tags
        if (tagsStr && hoverCardTags) {
          const tags = JSON.parse(tagsStr);
          if (tags.length > 0) {
            hoverCardTags.innerHTML = tags.map((tag: string) => 
              `<span class="text-xs px-2 py-0.5 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded text-[var(--text-tertiary)]">#${tag}</span>`
            ).join('');
            hoverCardTags.classList.remove('hidden');
          } else {
            hoverCardTags.classList.add('hidden');
          }
        }

        // Show hover card
        hoverCard.classList.remove('opacity-0', 'invisible');
        hoverCard.classList.add('opacity-100', 'visible');
      });

      link.addEventListener('mouseleave', () => {
        if (hoverCard) {
          hoverCard.classList.remove('opacity-100', 'visible');
          hoverCard.classList.add('opacity-0', 'invisible');
        }
      });
    });
  });
</script>
