---
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';

// Get all blog posts from the file system using import.meta.glob
const allPosts = import.meta.glob('./**/index.md', { eager: true });

// Convert glob result to array format
const blogPosts: any[] = Object.entries(allPosts).map(([path, module]: [string, any]) => {
  // Extract slug from path
  const pathParts = path.split('/');
  const slug = pathParts[pathParts.length - 2];
  
  return {
    ...module,
    url: `/blog/${slug}/`,
    slug,
  };
});

// Filter out template folders and drafts based on frontmatter
const isDevelopment = import.meta.env.DEV;
const publishedPosts = blogPosts.filter((post) => {
  const { slug } = post;
  
  // Exclude template folders (starting with _) and hidden folders (starting with .)
  if (slug && (slug.startsWith('_') || slug.startsWith('.'))) {
    return false;
  }
  
  // In development, show drafts; in production, exclude them
  if (!isDevelopment && post.frontmatter?.draft === true) {
    return false;
  }
  
  return true;
});

// Process and sort posts by date
const images = import.meta.glob<{ default: ImageMetadata }>('./**/_assets/*.{png,jpg,jpeg,gif,webp,svg}', { eager: true });

const posts = publishedPosts.map((post) => {
  const frontmatter = post.frontmatter || {};
  const { slug } = post;
  
  // Handle banner image if it exists (supports both local Obsidian paths and URLs)
  let bannerImage: any = null;
  if (frontmatter.banner) {
    // Check if it's a URL (starts with http:// or https://)
    if (frontmatter.banner.startsWith('http://') || frontmatter.banner.startsWith('https://')) {
      bannerImage = frontmatter.banner;
    } else {
      // Handle local Obsidian path (e.g., ./garrix.png or _assets/garrix.png)
      const bannerPath = frontmatter.banner.startsWith('./') 
        ? `./${slug}/_assets/${frontmatter.banner.slice(2)}`
        : `./${slug}/_assets/${frontmatter.banner}`;
      const localImage = images[bannerPath];
      if (localImage) {
        bannerImage = localImage.default;
      } else {
        console.warn(`Banner image not found for ${slug}:`, frontmatter.banner);
      }
    }
  }
  
  return {
    url: post.url,
    slug,
    title: frontmatter.title || 'Untitled',
    description: frontmatter.description || '',
    date: frontmatter.date ? new Date(frontmatter.date) : new Date(),
    tags: (frontmatter.tags || []) as string[],
    cover: bannerImage,
    draft: frontmatter.draft || false,
  };
});

// Sort by date (newest first)
posts.sort((a, b) => b.date.getTime() - a.date.getTime());

// Helper function to format file size (for terminal aesthetic)
function formatFileSize(title: string): string {
  return `${Math.floor(Math.random() * 10) + 1}K`;
}

// Helper function to get terminal color class based on file type
function getTerminalColor(index: number): string {
  const colors = ['terminal-blue', 'terminal-green', 'cyber-cyan', 'cyber-purple'];
  return colors[index % colors.length];
}
---

<Layout title="Blog - Milind Madhukar">
  <div class="min-h-screen py-20 px-6">
    <div class="max-w-6xl mx-auto">
      <!-- Terminal Header -->
      <div class="mb-12">
        <div class="flex items-center gap-3 mb-6">
          <a
            href="/"
            class="group flex items-center gap-2 text-[var(--text-tertiary)] hover:text-cyber-cyan transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="text-sm font-medium">Back to Home</span>
          </a>
        </div>

        <h1 class="text-5xl md:text-7xl font-black mb-4">
          <span class="cyber-text">My Thoughts</span>
        </h1>
        <p class="text-xl text-[var(--text-secondary)] font-mono">
          <span class="text-terminal-green">milind@portfolio</span>:<span class="text-terminal-blue">~/blog</span>$ ls -la
        </p>
      </div>

      {posts.length === 0 ? (
        <div class="text-center py-20">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-[var(--bg-elevated)] border border-[var(--border-color)] mb-6">
            <svg class="w-10 h-10 text-[var(--text-tertiary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <p class="text-2xl text-[var(--text-secondary)] mb-2">No posts yet</p>
          <p class="text-[var(--text-tertiary)] font-mono">$ echo "Coming soon..."</p>
        </div>
      ) : (
        <div class="space-y-0">
          <!-- Terminal listing header -->
          <div class="font-mono text-xs text-[var(--text-tertiary)] pb-2 border-b border-[var(--border-color)] mb-4 hidden md:grid md:grid-cols-[auto_1fr_auto_auto] gap-4">
            <span>PERMISSIONS</span>
            <span>NAME</span>
            <span>SIZE</span>
            <span>MODIFIED</span>
          </div>

          {posts.map((post, index) => {
            const colorClass = getTerminalColor(index);
            const permissions = post.draft ? 'drw-r--r--' : 'drwxr-xr-x';
            
            return (
              <div class="group relative">
                <a
                  href={post.url}
                  class="block py-3 px-4 -mx-4 rounded-lg hover:bg-[var(--bg-elevated)] transition-all duration-300 border border-transparent hover:border-[var(--border-color)]"
                >
                  <div class="font-mono text-sm grid md:grid-cols-[auto_1fr_auto_auto] gap-4 items-center">
                    <!-- Permissions -->
                    <span class="text-[var(--text-tertiary)] text-xs hidden md:block">
                      {permissions}
                    </span>

                    <!-- File name with color -->
                    <div class="flex items-center gap-2">
                      <span class="text-terminal-green hidden md:inline">ðŸ“„</span>
                      <span class={`text-${colorClass} font-semibold group-hover:underline decoration-${colorClass}/50 transition-all`}>
                        {post.title}
                      </span>
                      {post.draft && (
                        <span class="px-2 py-0.5 text-xs bg-terminal-yellow/20 text-terminal-yellow border border-terminal-yellow/50 rounded">
                          draft
                        </span>
                      )}
                    </div>

                    <!-- Size -->
                    <span class="text-[var(--text-tertiary)] text-xs hidden md:block">
                      {formatFileSize(post.title)}
                    </span>

                    <!-- Date -->
                    <span class="text-[var(--text-tertiary)] text-xs">
                      {post.date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: '2-digit',
                        year: 'numeric'
                      })}
                    </span>
                  </div>

                  <!-- Mobile date -->
                  <div class="md:hidden text-xs text-[var(--text-tertiary)] mt-1 ml-0 font-mono">
                    {post.date.toLocaleDateString('en-US', {
                      month: 'short',
                      day: '2-digit',
                      year: 'numeric'
                    })}
                  </div>
                </a>

                <!-- Hover preview card -->
                {(post.description || post.cover) && (
                  <div class="absolute left-full ml-8 top-0 w-80 p-4 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50 pointer-events-none hidden xl:block">
                    {post.cover && (
                      <div class="mb-3 rounded-lg overflow-hidden border border-[var(--border-color)]">
                        {typeof post.cover === 'string' ? (
                          <img 
                            src={post.cover} 
                            alt={post.title}
                            class="w-full h-40 object-cover"
                          />
                        ) : (
                          <Image
                            src={post.cover}
                            alt={post.title}
                            width={400}
                            height={200}
                            class="w-full h-40 object-cover"
                          />
                        )}
                      </div>
                    )}
                    {post.description && (
                      <p class="text-sm text-[var(--text-secondary)] leading-relaxed">
                        {post.description}
                      </p>
                    )}
                    {post.tags.length > 0 && (
                      <div class="flex flex-wrap gap-1 mt-3 pt-3 border-t border-[var(--border-color)]">
                        {post.tags.map((tag: string) => (
                          <span class="text-xs px-2 py-0.5 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded text-[var(--text-tertiary)]">
                            #{tag}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}

      <!-- Terminal footer -->
      <div class="mt-8 pt-6 border-t border-[var(--border-color)]">
        <p class="font-mono text-sm text-[var(--text-tertiary)]">
          <span class="text-terminal-green">$</span> Found {posts.length} {posts.length === 1 ? 'post' : 'posts'}
        </p>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Terminal listing styles */
  a:hover .text-terminal-blue,
  a:hover .text-terminal-green,
  a:hover .text-cyber-cyan,
  a:hover .text-cyber-purple {
    filter: brightness(1.3);
  }
</style>
