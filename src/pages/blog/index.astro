---
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';

// Get all blog posts from the file system
const blogPosts = await Astro.glob('./**/index.md');

// Filter out drafts (folders starting with _)
const publishedPosts = blogPosts.filter((post) => {
  const urlParts = post.url?.split('/') || [];
  const folder = urlParts[urlParts.length - 2];
  return folder && !folder.startsWith('_');
});

// Process and sort posts by date
const posts = await Promise.all(
  publishedPosts.map(async (post) => {
    const frontmatter = post.frontmatter || {};
    
    // Extract the slug from the URL
    const urlParts = post.url?.split('/') || [];
    const slug = urlParts[urlParts.length - 2];
    
    // Handle cover image if it exists
    let coverImage: any = null;
    if (frontmatter.cover) {
      try {
        // Import the cover image from the assets folder
        const images = import.meta.glob<{ default: ImageMetadata }>('./**/assets/*', { eager: true });
        const coverPath = `./${slug}/assets/${frontmatter.cover}`;
        coverImage = images[coverPath];
      } catch (e) {
        console.warn(`Cover image not found for ${slug}:`, frontmatter.cover);
      }
    }
    
    return {
      url: post.url,
      slug,
      title: frontmatter.title || 'Untitled',
      description: frontmatter.description || '',
      date: frontmatter.date ? new Date(frontmatter.date) : new Date(),
      author: frontmatter.author || 'Anonymous',
      tags: (frontmatter.tags || []) as string[],
      cover: coverImage?.default || null,
      draft: frontmatter.draft || false,
    };
  })
);

// Sort by date (newest first)
posts.sort((a, b) => b.date.getTime() - a.date.getTime());
---

<Layout title="Blog">
  <div class="min-h-screen bg-black text-white">
    <div class="max-w-4xl mx-auto px-4 py-16">
      <h1 class="text-4xl font-bold mb-8">Blog</h1>
      
      {posts.length === 0 ? (
        <p class="text-gray-400">No blog posts published yet.</p>
      ) : (
        <div class="space-y-8">
          {posts.map((post) => (
            <article class="border border-gray-800 rounded-lg overflow-hidden hover:border-gray-600 transition-colors">
              <a href={post.url} class="block">
                {post.cover && (
                  <div class="aspect-video overflow-hidden bg-gray-900">
                    <Image
                      src={post.cover}
                      alt={post.title}
                      width={800}
                      height={450}
                      class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                    />
                  </div>
                )}
                
                <div class="p-6">
                  <div class="flex items-center gap-4 text-sm text-gray-400 mb-3">
                    <time datetime={post.date.toISOString()}>
                      {post.date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                      })}
                    </time>
                    {post.author && (
                      <>
                        <span>â€¢</span>
                        <span>{post.author}</span>
                      </>
                    )}
                  </div>
                  
                  <h2 class="text-2xl font-bold mb-2 hover:text-blue-400 transition-colors">
                    {post.title}
                  </h2>
                  
                  {post.description && (
                    <p class="text-gray-400 mb-4">
                      {post.description}
                    </p>
                  )}
                  
                  {post.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                      {post.tags.map((tag: string) => (
                        <span class="text-xs px-2 py-1 bg-gray-800 rounded-full text-gray-300">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </a>
            </article>
          ))}
        </div>
      )}
    </div>
  </div>
</Layout>
