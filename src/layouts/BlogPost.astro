---
import Layout from "./Layout.astro";
import "../styles/global.css";
import { Image } from "astro:assets";
import SocialButton from "../components/SocialButton.astro";
import {
  formatDateLong,
  parseCustomDate,
  getWordCount,
  formatWordCount,
  calculateReadingTime,
  formatReadingTime,
} from "../lib/date.ts";
import {
  processExcalidrawImage,
  extractBannerFilename,
} from "../lib/excalidraw";

const { frontmatter, headings, rawContent } = Astro.props;
const { title, description, date, tags, banner } = frontmatter;

// Format the date (only date part, no time)
const formattedDate = date ? formatDateLong(parseCustomDate(date)) : "";

// Calculate word count and reading time
const content = rawContent ? rawContent() : "";
const wordCount = getWordCount(content);
const readingTime = calculateReadingTime(wordCount);
const wordCountFormatted = formatWordCount(wordCount);
const readingTimeFormatted = formatReadingTime(readingTime);

// Handle banner image if it exists (supports both local Obsidian paths and URLs)
let bannerImage: any = null;
let bannerImageUrl: string | null = null;
let bannerLightImage: any = null;
let bannerDarkImage: any = null;
let isExcalidrawBanner = false;

if (banner) {
  const bannerFilename = extractBannerFilename(banner);

  // Check if it's a URL (starts with http:// or https://)
  if (
    bannerFilename.startsWith("http://") ||
    bannerFilename.startsWith("https://")
  ) {
    bannerImage = bannerFilename;
    bannerImageUrl = bannerFilename;
  } else {
    // Get the current file path to determine the slug
    const url = Astro.url.pathname;
    const pathParts = url.split("/").filter(Boolean);
    const slug =
      pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

    try {
      const images = import.meta.glob<{ default: ImageMetadata }>(
        "/src/pages/blog/**/_assets/**/*.{png,jpg,jpeg,gif,webp,svg}",
        { eager: true },
      );

      // Check if this is an Excalidraw image
      const excalidrawResult = processExcalidrawImage(
        bannerFilename,
        images,
        slug,
      );

      if (excalidrawResult.isExcalidraw) {
        isExcalidrawBanner = true;
        bannerLightImage = excalidrawResult.lightImage;
        bannerDarkImage = excalidrawResult.darkImage;

        // Use fallback for social media (prefers light variant)
        bannerImage = excalidrawResult.fallbackImage;
        if (bannerImage && excalidrawResult.baseName) {
          const variant = bannerLightImage ? "light" : "dark";
          bannerImageUrl = new URL(
            `/blog/${slug}/_assets/excalidraw/${excalidrawResult.baseName}.${variant}.png`,
            Astro.site,
          ).toString();
        }
      } else {
        // Regular image handling
        const bannerPath = bannerFilename.startsWith("./")
          ? `/src/pages/blog/${slug}/_assets/${bannerFilename.slice(2)}`
          : `/src/pages/blog/${slug}/_assets/${bannerFilename}`;
        const localImage = images[bannerPath];
        if (localImage) {
          bannerImage = localImage.default;
          // Create full URL for social media
          bannerImageUrl = new URL(
            `/blog/${slug}/_assets/${bannerFilename.replace("./", "")}`,
            Astro.site,
          ).toString();
        }
      }
    } catch (e) {
      console.warn("Banner image not found:", banner);
    }
  }
}

// Use banner image for social media, otherwise use favicon
const socialImage = bannerImageUrl || `${Astro.site}favicon.ico`;

// Create fun blog description
const blogDescription =
  description ||
  "ðŸ’¡ Dive into the digital rabbit hole! Tech tales, DevOps adventures, and code wisdom served with a side of chaos. Warning: May contain terrible jokes and actual useful information.";

// Filter headings to only include h2 and h3 for TOC
const tocHeadings =
  headings?.filter((h: any) => h.depth >= 2 && h.depth <= 3) || [];
---

<Layout title={title} description={blogDescription} image={socialImage}>
  <div
    class="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)] overflow-y-auto cyber-grid relative"
  >
    <!-- Scanline effect -->
    <div class="scanlines absolute inset-0 pointer-events-none opacity-20">
    </div>

    <div
      class="max-w-7xl mx-auto px-4 sm:px-6 py-8 sm:py-16 lg:flex lg:gap-8 lg:items-start relative z-10"
    >
      <!-- Main content -->
      <div class="flex-1 max-w-4xl lg:max-w-3xl">
        <!-- Terminal-style breadcrumb navigation -->
        <div class="mb-8 sm:mb-12">
          <p class="text-sm font-mono text-[var(--text-tertiary)] mb-4">
            <span class="text-terminal-green">milind@blog</span>:<span
              class="text-terminal-blue">~/posts</span
            >$ cat {title.toLowerCase().replace(/\s+/g, "-")}.md
          </p>
          <a
            href="/blog"
            class="group inline-flex items-center gap-2 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"
          >
            <div
              class="p-2 rounded-lg bg-[var(--bg-elevated)] group-hover:bg-[var(--bg-secondary)] transition-colors border border-[var(--border-color)]"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"></path>
              </svg>
            </div>
            <span class="font-medium">Back to Blog</span>
          </a>
        </div>

        <!-- Mobile TOC - Collapsible inline section -->
        {
          tocHeadings.length > 0 && (
            <details class="lg:hidden mb-8 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-xl overflow-hidden">
              <summary class="cursor-pointer px-6 py-4 font-bold text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] transition-colors flex items-center justify-between group">
                <span class="flex items-center gap-2">
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h7"
                    />
                  </svg>
                  Table of Contents
                </span>
                <svg
                  class="w-5 h-5 transition-transform group-open:rotate-180"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </summary>
              <nav class="px-6 py-4 border-t border-[var(--border-color)]">
                <ul class="space-y-1">
                  {tocHeadings.map((heading: any) => (
                    <li
                      style={`margin-left: ${(heading.depth - 2) * 1}rem`}
                      class=""
                    >
                      <a
                        href={`#${heading.slug}`}
                        class="mobile-toc-link block py-2 px-3 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] rounded transition-all text-sm border-l-2 border-transparent hover:border-[var(--text-primary)]"
                        data-heading-id={heading.slug}
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            </details>
          )
        }

        <!-- Article header with gradient -->
        <article class="prose prose-invert prose-lg max-w-none">
          <header
            class="mb-8 sm:mb-12 pb-8 border-b border-[var(--border-color)]"
          >
            <h1
              class="text-4xl sm:text-5xl md:text-6xl font-bold mb-6 leading-tight"
            >
              <span class="cyber-text">{title}</span>
            </h1>

            {
              description && (
                <p class="text-base sm:text-lg text-[var(--text-secondary)] mb-6 leading-relaxed">
                  {description}
                </p>
              )
            }

            {
              (bannerImage || isExcalidrawBanner) && (
                <div
                  class={
                    isExcalidrawBanner
                      ? "excalidraw-container my-8 -mx-4 sm:mx-0"
                      : "my-8 -mx-4 sm:mx-0 rounded-none sm:rounded-2xl overflow-hidden border-0 sm:border border-[var(--border-color)]"
                  }
                >
                  {isExcalidrawBanner ? (
                    <>
                      {bannerLightImage && (
                        <Image
                          src={bannerLightImage}
                          alt={title}
                          width={1200}
                          height={675}
                          class="excalidraw-light"
                          loading="eager"
                        />
                      )}
                      {bannerDarkImage && (
                        <Image
                          src={bannerDarkImage}
                          alt={title}
                          width={1200}
                          height={675}
                          class="excalidraw-dark"
                          loading="eager"
                        />
                      )}
                    </>
                  ) : typeof bannerImage === "string" ? (
                    <img
                      src={bannerImage}
                      alt={title}
                      class="w-full h-auto object-cover"
                      loading="eager"
                    />
                  ) : (
                    <Image
                      src={bannerImage}
                      alt={title}
                      width={1200}
                      height={675}
                      class="w-full h-auto object-cover"
                      loading="eager"
                    />
                  )}
                </div>
              )
            }

            <div class="flex flex-wrap items-center gap-4 text-sm">
              {
                formattedDate && (
                  <div class="flex items-center gap-2 text-[var(--text-secondary)]">
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                      />
                    </svg>
                    <time datetime={date} class="font-medium">
                      {formattedDate}
                    </time>
                  </div>
                )
              }

              {
                wordCount > 0 && (
                  <div class="flex items-center gap-2 text-[var(--text-secondary)]">
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      />
                    </svg>
                    <span class="font-medium">{wordCount} words</span>
                  </div>
                )
              }

              {
                readingTime > 0 && (
                  <div class="flex items-center gap-2 text-[var(--text-secondary)]">
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <span class="font-medium">{readingTimeFormatted}</span>
                  </div>
                )
              }
            </div>

            {
              tags && tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-6">
                  {tags.map((tag: string) => (
                    <span class="px-3 py-1 text-sm font-mono bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded">
                      #{tag}
                    </span>
                  ))}
                </div>
              )
            }
          </header>

          <!-- Article content with enhanced styling -->
          <div class="blog-content">
            <slot />
          </div>

          <!-- Back to blog footer -->
          <footer class="mt-16 pt-8 border-t border-[var(--border-color)]">
            <div class="mb-8">
              <p class="text-sm font-mono text-[var(--text-tertiary)] mb-4">
                <span class="text-terminal-green">milind@blog</span>:<span
                  class="text-terminal-blue">~/posts</span
                >$ cd ..
              </p>
              <a
                href="/blog"
                class="group inline-flex items-center gap-2 text-cyber-purple hover:text-cyber-cyan transition-colors font-medium"
              >
                <svg
                  class="w-5 h-5 group-hover:-translate-x-1 transition-transform"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                View all posts
              </a>
            </div>

            <!-- Social Links & RSS -->
            <div class="mt-8 pt-8 border-t border-[var(--border-color)]">
              <div class="flex flex-col gap-6">
                <div>
                  <h3
                    class="text-sm font-mono text-[var(--text-tertiary)] mb-3"
                  >
                    <span class="text-terminal-green">$</span> Connect with me:
                  </h3>
                  <div class="flex flex-wrap gap-3">
                    <!-- RSS Feed -->
                    <a
                      href="/blog/rss.xml"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="group flex items-center gap-2 px-4 py-2 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-lg hover:border-neon-orange transition-all"
                      aria-label="RSS Feed"
                    >
                      <svg
                        class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity text-[var(--color-neon-orange)]"
                        fill="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"
                        ></path>
                      </svg>
                      <span
                        class="text-sm font-medium text-[var(--text-secondary)] group-hover:text-neon-orange transition-colors"
                      >
                        RSS Feed
                      </span>
                    </a>
                  </div>
                </div>

                <div class="pt-4 border-t border-[var(--border-color)]">
                  <p class="text-xs font-mono text-[var(--text-tertiary)]">
                    <span class="text-terminal-blue">Â©</span>
                    {new Date().getFullYear()} Milind Madhukar
                  </p>
                </div>
              </div>
            </div>
          </footer>
        </article>
      </div>

      <!-- Desktop TOC Sidebar -->
      {
        tocHeadings.length > 0 && (
          <aside class="hidden lg:block lg:w-64 xl:w-72 flex-shrink-0">
            <div class="sticky top-8">
              <div class="bg-[var(--bg-elevated)] backdrop-blur-sm border border-[var(--border-color)] rounded-2xl p-6 shadow-xl">
                <h2 class="text-lg font-bold mb-4 text-[var(--text-primary)]">
                  Table of Contents
                </h2>
                <nav class="toc-nav">
                  <ul class="space-y-1">
                    {tocHeadings.map((heading: any) => (
                      <li
                        style={`margin-left: ${(heading.depth - 2) * 0.75}rem`}
                        class=""
                      >
                        <a
                          href={`#${heading.slug}`}
                          class="toc-link block py-2 px-3 text-[var(--text-secondary)] hover:text-cyber-purple hover:bg-cyber-purple/10 rounded transition-all text-sm border-l-2 border-transparent hover:border-cyber-purple"
                          data-heading-id={heading.slug}
                        >
                          {heading.text}
                        </a>
                      </li>
                    ))}
                  </ul>
                </nav>
              </div>
            </div>
          </aside>
        )
      }
    </div>
  </div>
</Layout>

<style is:global>
  /* Override base layout styles for blog posts */
  html,
  body {
    overflow: visible !important;
    height: auto !important;
    scroll-behavior: smooth;
  }

  /* Blog content styles with enhanced typography */
  .blog-content {
    color: var(--text-primary);
    font-size: 1.125rem;
    line-height: 1.8;
  }

  .blog-content :is(h1, h2, h3, h4, h5, h6) {
    color: var(--text-primary);
    font-weight: 700;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    line-height: 1.3;
    scroll-margin-top: 2rem;
  }

  .blog-content h1 {
    font-size: 2.25rem;
  }
  .blog-content h2 {
    font-size: 1.875rem;
  }
  .blog-content h3 {
    font-size: 1.5rem;
  }
  .blog-content h4 {
    font-size: 1.25rem;
  }

  .blog-content p {
    margin-bottom: 1.5rem;
    line-height: 1.8;
  }

  .blog-content a {
    color: var(--color-cyber-purple);
    text-decoration: underline;
    text-decoration-color: var(--color-cyber-purple);
    text-underline-offset: 3px;
    transition: all 0.2s;
  }

  .blog-content a:hover {
    color: var(--color-cyber-cyan);
    text-decoration-color: var(--color-cyber-cyan);
  }

  .blog-content img {
    border-radius: 0.75rem;
    margin-top: 2.5rem;
    margin-bottom: 2.5rem;
    width: 100%;
    height: auto;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .blog-content :is(ul, ol) {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
  }

  .blog-content li {
    margin-bottom: 0.75rem;
    padding-left: 0.5rem;
    color: var(--text-secondary);
  }

  .blog-content ul li {
    list-style-type: none;
    position: relative;
  }

  .blog-content ul li::before {
    content: "â–¹";
    position: absolute;
    left: -1.5rem;
    color: var(--color-terminal-green);
    font-weight: bold;
  }

  .blog-content ol li {
    list-style-type: decimal;
    list-style-position: outside;
  }

  .blog-content ol li::marker {
    color: var(--color-cyber-purple);
    font-weight: bold;
  }

  .blog-content code {
    background: var(--bg-elevated);
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.9em;
    color: var(--color-terminal-yellow);
    border: 1px solid var(--border-color);
    font-family: "JetBrains Mono", "Courier New", monospace;
  }

  .blog-content pre {
    background: var(--bg-elevated);
    padding: 1.5rem;
    border-radius: 1rem;
    overflow-x: auto;
    margin: 2rem 0;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  }

  .blog-content pre code {
    background: transparent;
    padding: 0;
    border: none;
    color: var(--text-primary);
    box-shadow: none;
  }

  .blog-content blockquote {
    border-left: 4px solid var(--color-cyber-purple);
    padding-left: 1.5rem;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    font-style: italic;
    color: var(--text-secondary);
    margin: 2rem 0;
    background: var(--bg-elevated);
    border-radius: 0 0.5rem 0.5rem 0;
  }

  .blog-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .blog-content :is(th, td) {
    border: 1px solid var(--border-color);
    padding: 0.75rem 1rem;
    text-align: left;
  }

  .blog-content th {
    background: var(--bg-elevated);
    font-weight: 700;
    color: var(--color-cyber-purple);
  }

  .blog-content tr:nth-child(even) {
    background: var(--bg-elevated);
  }

  .blog-content hr {
    border: none;
    height: 1px;
    background: linear-gradient(
      to right,
      transparent,
      var(--border-color),
      transparent
    );
    margin: 3rem 0;
  }

  .blog-content strong {
    color: var(--text-primary);
    font-weight: 700;
  }

  .blog-content em {
    color: var(--text-secondary);
  }

  /* Excalidraw theme-aware image container */
  .excalidraw-container {
    position: relative;
    margin-top: 3rem;
    margin-bottom: 3rem;
    border-radius: 1rem;
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .excalidraw-container img {
    width: 100%;
    height: auto;
    margin: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
  }

  /* Default theme is mocha (dark) - show dark images */
  .excalidraw-container .excalidraw-light {
    display: none !important;
  }

  .excalidraw-container .excalidraw-dark {
    display: block !important;
  }

  /* When latte theme is active - show light images */
  .latte .excalidraw-container .excalidraw-light {
    display: block !important;
  }

  .latte .excalidraw-container .excalidraw-dark {
    display: none !important;
  }

  /* TOC Active Link Styles */
  .toc-link.active {
    color: var(--color-cyber-purple);
    background: oklch(0.65 0.28 290 / 0.15);
    border-left-color: var(--color-cyber-purple);
  }

  /* Blog Image Modal Styles */
  .blog-image-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .blog-image-modal.active {
    display: flex;
    opacity: 1;
  }

  .blog-image-modal .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
  }

  .blog-image-modal .modal-content {
    position: relative;
    width: 95vw;
    height: 95vh;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
  }

  .blog-image-modal .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    padding: 0.75rem;
    color: white;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
  }

  .blog-image-modal .modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
  }

  .blog-image-modal .modal-image-container {
    position: relative;
    max-width: 90%;
    max-height: 90%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .blog-image-modal .modal-image {
    max-width: 100%;
    max-height: 85vh;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 0.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    cursor: pointer;
  }

  .blog-image-modal .modal-image.magnifying {
    cursor: none;
  }

  .blog-image-modal .magnify-lens {
    position: absolute;
    width: 200px;
    height: 200px;
    border: 3px solid white;
    border-radius: 50%;
    pointer-events: none;
    display: none;
    background-repeat: no-repeat;
    box-shadow:
      0 0 20px rgba(0, 0, 0, 0.5),
      inset 0 0 20px rgba(255, 255, 255, 0.2);
    z-index: 100;
    overflow: hidden;
  }

  .blog-image-modal .magnify-lens.active {
    display: block;
  }

  .blog-image-modal .modal-instructions {
    position: absolute;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: center;
    z-index: 10;
    padding-bottom: 1rem;
  }

  .blog-image-modal .instruction-badge {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 2rem;
    padding: 0.5rem 1.25rem;
    color: white;
    font-size: 0.875rem;
    font-weight: 500;
    backdrop-filter: blur(10px);
    animation: fadeInDown 0.3s ease;
  }

  .blog-image-modal .hidden {
    display: none !important;
  }

  .blog-image-wrapper {
    transition: all 0.3s ease;
  }

  .blog-image-wrapper:hover img {
    transform: translateY(-2px);
  }

  @media (max-width: 640px) {
    .blog-image-modal .modal-image-container {
      max-width: 95%;
    }

    .blog-image-modal .instruction-badge {
      font-size: 0.75rem;
      padding: 0.375rem 1rem;
    }
  }

  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  // Auto-close mobile TOC details when clicking a link
  const mobileTocDetails = document.querySelector("details.lg\\:hidden");
  if (mobileTocDetails) {
    const mobileTocLinks =
      mobileTocDetails.querySelectorAll(".mobile-toc-link");
    mobileTocLinks.forEach((link) => {
      link.addEventListener("click", () => {
        mobileTocDetails.removeAttribute("open");
      });
    });
  }

  // Active section highlighting with intersection observer
  const observerOptions = {
    rootMargin: "-80px 0px -80% 0px",
    threshold: 0,
  };

  const headingElements = document.querySelectorAll(
    ".blog-content h2, .blog-content h3",
  );
  const tocLinks = document.querySelectorAll(".toc-link, .mobile-toc-link");

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        // Remove active class from all links
        tocLinks.forEach((link) => link.classList.remove("active"));
        // Add active class to current link (both desktop and mobile)
        const activeLinkDesktop = document.querySelector(
          `.toc-link[data-heading-id="${id}"]`,
        );
        const activeLinkMobile = document.querySelector(
          `.mobile-toc-link[data-heading-id="${id}"]`,
        );
        if (activeLinkDesktop) {
          activeLinkDesktop.classList.add("active");
        }
        if (activeLinkMobile) {
          activeLinkMobile.classList.add("active");
        }
      }
    });
  }, observerOptions);

  headingElements.forEach((heading) => observer.observe(heading));

  // Enhanced image zoom functionality
  function enhanceBlogImages() {
    const blogImages = document.querySelectorAll(".blog-content img");

    blogImages.forEach((imgEl, index) => {
      const img = imgEl as HTMLImageElement;

      // Skip if already enhanced
      if (img.hasAttribute("data-zoom-enhanced")) return;

      img.setAttribute("data-zoom-enhanced", "true");
      const imageId = `blog-img-${index}`;

      // Wrap image in a container with cursor pointer
      const wrapper = document.createElement("div");
      wrapper.className = "blog-image-wrapper";
      wrapper.style.cssText = "position: relative; cursor: zoom-in;";
      const parent = img.parentNode;
      if (parent) {
        parent.insertBefore(wrapper, img);
        wrapper.appendChild(img);
      }

      // Create modal
      const modal = document.createElement("div");
      modal.id = `modal-${imageId}`;
      modal.className = "blog-image-modal";
      modal.innerHTML = `
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <div class="modal-instructions">
            <div class="instruction-badge" data-desktop-hint>
              Click & hold to activate magnifying glass
            </div>
            <div class="instruction-badge hidden" data-mobile-hint>
              Pinch to zoom
            </div>
            <div class="instruction-badge hidden" data-magnify-hint>
              Scroll to zoom in/out
            </div>
          </div>
          <button class="modal-close" aria-label="Close">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <div class="modal-image-container">
            <img src="${img.src}" alt="${img.alt}" class="modal-image" data-full-image />
            <div class="magnify-lens" data-lens></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Detect touch device
      const isTouchDevice =
        "ontouchstart" in window || navigator.maxTouchPoints > 0;

      // Modal functionality
      const modalBackdrop = modal.querySelector(".modal-backdrop");
      const modalClose = modal.querySelector(".modal-close");
      const modalImage = modal.querySelector(
        "[data-full-image]",
      ) as HTMLImageElement | null;
      const lens = modal.querySelector("[data-lens]") as HTMLElement | null;
      const magnifyHint = modal.querySelector(
        "[data-magnify-hint]",
      ) as HTMLElement | null;
      const desktopHint = modal.querySelector(
        "[data-desktop-hint]",
      ) as HTMLElement | null;
      const mobileHint = modal.querySelector(
        "[data-mobile-hint]",
      ) as HTMLElement | null;

      let magnifyActive = false;
      let zoomLevel = 3;
      const minZoom = 1.5;
      const maxZoom = 5;
      let lensSize = 0;

      // Open modal
      wrapper.addEventListener("click", () => {
        modal.classList.add("active");
        document.body.style.overflow = "hidden";

        // Show appropriate hint based on device type
        if (isTouchDevice) {
          if (mobileHint) mobileHint.classList.remove("hidden");
          if (desktopHint) desktopHint.classList.add("hidden");
        } else {
          if (desktopHint) desktopHint.classList.remove("hidden");
          if (mobileHint) mobileHint.classList.add("hidden");

          // Calculate and set lens size to 80% of viewport height
          if (lens) {
            lensSize = window.innerHeight * 0.8;
            lens.style.width = `${lensSize}px`;
            lens.style.height = `${lensSize}px`;
          }
        }
      });

      // Close modal
      const closeModal = () => {
        modal.classList.remove("active");
        document.body.style.overflow = "";
        magnifyActive = false;
        if (lens) {
          lens.classList.remove("active");
          lens.style.display = "none";
        }
        if (modalImage) modalImage.classList.remove("magnifying");
        zoomLevel = 3;
        if (magnifyHint) magnifyHint.classList.add("hidden");
        if (desktopHint) desktopHint.classList.remove("hidden");
        if (mobileHint) mobileHint.classList.add("hidden");
      };

      modalBackdrop?.addEventListener("click", closeModal);
      modalClose?.addEventListener("click", closeModal);

      // ESC key to close
      const handleEsc = (e: KeyboardEvent) => {
        if (e.key === "Escape" && modal.classList.contains("active")) {
          closeModal();
        }
      };
      document.addEventListener("keydown", handleEsc);

      // Only add magnifying glass functionality on non-touch devices
      if (!isTouchDevice) {
        // Activate magnifying glass on mousedown
        modalImage?.addEventListener("mousedown", (e: MouseEvent) => {
          e.preventDefault();
          magnifyActive = true;

          if (lens && modalImage) {
            // Show lens at cursor position immediately
            const rect = modalImage.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            lens.style.left = `${x - lensSize / 2}px`;
            lens.style.top = `${y - lensSize / 2}px`;
            lens.style.display = "block";
            lens.classList.add("active");

            // Calculate and set initial background
            const bgX = -(x * zoomLevel - lensSize / 2);
            const bgY = -(y * zoomLevel - lensSize / 2);
            lens.style.backgroundImage = `url('${modalImage.src}')`;
            lens.style.backgroundSize = `${rect.width * zoomLevel}px ${rect.height * zoomLevel}px`;
            lens.style.backgroundPosition = `${bgX}px ${bgY}px`;
          }

          if (modalImage) modalImage.classList.add("magnifying");
          if (magnifyHint) magnifyHint.classList.remove("hidden");
          if (desktopHint) desktopHint.classList.add("hidden");
        });

        // Deactivate magnifying glass on mouseup
        const deactivateMagnify = () => {
          magnifyActive = false;
          if (lens) {
            lens.classList.remove("active");
            lens.style.display = "none";
          }
          if (modalImage) modalImage.classList.remove("magnifying");
          if (magnifyHint) magnifyHint.classList.add("hidden");
          if (desktopHint) desktopHint.classList.remove("hidden");
        };

        modalImage?.addEventListener("mouseup", deactivateMagnify);
        modalImage?.addEventListener("mouseleave", deactivateMagnify);
        document.addEventListener("mouseup", () => {
          if (magnifyActive && modal.classList.contains("active")) {
            deactivateMagnify();
          }
        });

        // Magnifying glass movement
        modalImage?.addEventListener("mousemove", (e: MouseEvent) => {
          if (!magnifyActive || !lens || !modalImage) return;

          const rect = modalImage.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // Position the lens
          lens.style.left = `${x - lensSize / 2}px`;
          lens.style.top = `${y - lensSize / 2}px`;

          // Calculate background position for zoom effect
          const bgX = -(x * zoomLevel - lensSize / 2);
          const bgY = -(y * zoomLevel - lensSize / 2);

          lens.style.backgroundImage = `url('${modalImage.src}')`;
          lens.style.backgroundSize = `${rect.width * zoomLevel}px ${rect.height * zoomLevel}px`;
          lens.style.backgroundPosition = `${bgX}px ${bgY}px`;
        });

        // Scroll to zoom - zooms from center of lens
        modalImage?.addEventListener(
          "wheel",
          (e: WheelEvent) => {
            if (!magnifyActive || !lens || !modalImage) return;

            e.preventDefault();

            const rect = modalImage.getBoundingClientRect();

            // Get current lens position
            const lensLeft = parseFloat(lens.style.left) || 0;
            const lensTop = parseFloat(lens.style.top) || 0;

            // Calculate center of lens relative to image
            const lensCenterX = lensLeft + lensSize / 2;
            const lensCenterY = lensTop + lensSize / 2;

            // Update zoom level
            const delta = e.deltaY > 0 ? -0.2 : 0.2;
            zoomLevel = Math.max(minZoom, Math.min(maxZoom, zoomLevel + delta));

            // Calculate new background position to keep center point stable
            const bgX = -(lensCenterX * zoomLevel - lensSize / 2);
            const bgY = -(lensCenterY * zoomLevel - lensSize / 2);

            lens.style.backgroundSize = `${rect.width * zoomLevel}px ${rect.height * zoomLevel}px`;
            lens.style.backgroundPosition = `${bgX}px ${bgY}px`;
          },
          { passive: false },
        );
      }
    });
  }

  // Initialize image enhancements
  enhanceBlogImages();
</script>
