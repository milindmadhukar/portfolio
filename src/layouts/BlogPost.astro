
---
import Layout from './Layout.astro';
import '../styles/global.css';
import { Image } from 'astro:assets';

const { frontmatter, headings } = Astro.props;
const { title, description, date, tags, banner } = frontmatter;

// Format the date
const formattedDate = date ? new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
}) : '';

// Handle banner image if it exists (supports both local Obsidian paths and URLs)
let bannerImage: any = null;
if (banner) {
  // Check if it's a URL (starts with http:// or https://)
  if (banner.startsWith('http://') || banner.startsWith('https://')) {
    bannerImage = banner;
  } else {
    // Handle local Obsidian path (e.g., ./garrix.png or _assets/garrix.png)
    // Get the current file path to determine the slug
    const url = Astro.url.pathname;
    const pathParts = url.split('/').filter(Boolean);
    const slug = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
    
    try {
      const images = import.meta.glob<{ default: ImageMetadata }>('/src/pages/blog/**/_assets/*.{png,jpg,jpeg,gif,webp,svg}', { eager: true });
      const bannerPath = banner.startsWith('./') 
        ? `/src/pages/blog/${slug}/_assets/${banner.slice(2)}`
        : `/src/pages/blog/${slug}/_assets/${banner}`;
      const localImage = images[bannerPath];
      if (localImage) {
        bannerImage = localImage.default;
      }
    } catch (e) {
      console.warn('Banner image not found:', banner);
    }
  }
}

// Filter headings to only include h2 and h3 for TOC
const tocHeadings = headings?.filter((h: any) => h.depth >= 2 && h.depth <= 3) || [];
---

<Layout>
  <div class="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)] overflow-y-auto">
    <!-- Mobile TOC Toggle Button (fixed at top) -->
    {tocHeadings.length > 0 && (
      <button 
        id="mobile-toc-toggle"
        class="lg:hidden fixed top-4 right-4 z-50 p-3 bg-[var(--bg-elevated)] backdrop-blur-sm rounded-lg border border-[var(--border-color)] shadow-lg hover:bg-[var(--bg-secondary)] transition-colors"
        aria-label="Toggle table of contents"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    )}

    <!-- Mobile TOC Overlay -->
    {tocHeadings.length > 0 && (
      <div 
        id="mobile-toc-overlay"
        class="lg:hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden"
      >
        <div class="fixed top-0 right-0 h-full w-80 max-w-[85vw] bg-[var(--bg-elevated)] border-l border-[var(--border-color)] shadow-2xl overflow-y-auto">
          <div class="p-6">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold cyber-text">
                Table of Contents
              </h2>
              <button 
                id="mobile-toc-close"
                class="p-2 hover:bg-[var(--bg-secondary)] rounded-lg transition-colors"
                aria-label="Close table of contents"
              >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <nav class="toc-nav">
              <ul class="space-y-1">
                {tocHeadings.map((heading: any) => (
                  <li style={`margin-left: ${(heading.depth - 2) * 1}rem`}>
                    <a 
                      href={`#${heading.slug}`}
                      class="toc-link block py-2 px-3 text-[var(--text-secondary)] hover:text-cyber-purple hover:bg-cyber-purple/10 rounded transition-all text-sm border-l-2 border-transparent hover:border-cyber-purple"
                      data-heading-id={heading.slug}
                    >
                      {heading.text}
                    </a>
                  </li>
                ))}
              </ul>
            </nav>
          </div>
        </div>
      </div>
    )}

    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8 sm:py-16 lg:flex lg:gap-8 lg:items-start">
      <!-- Main content -->
      <div class="flex-1 max-w-4xl lg:max-w-3xl">
        <!-- Back to blog link with home icon -->
        <div class="mb-8 sm:mb-12 flex items-center gap-4">
          <a href="/blog" class="group inline-flex items-center gap-2 text-[var(--text-secondary)] hover:text-cyber-purple transition-colors">
            <div class="p-2 rounded-lg bg-[var(--bg-elevated)] group-hover:bg-cyber-purple/10 transition-colors border border-[var(--border-color)]">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </div>
            <span class="font-medium">Back to Blog</span>
          </a>
        </div>
        
        <!-- Article header with gradient -->
        <article class="prose prose-invert prose-lg max-w-none">
          <header class="mb-8 sm:mb-12 pb-8 border-b border-[var(--border-color)]">
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold mb-6 leading-tight text-[var(--text-primary)]">
              <span class="text-[var(--text-tertiary)] font-normal">My thoughts on</span>{' '}
              <span class="cyber-text">{title}</span>
              <span class="vim-cursor ml-1">█</span>
            </h1>
            
            {description && (
              <p class="text-lg sm:text-xl md:text-2xl text-[var(--text-secondary)] mb-6 leading-relaxed">
                {description}
              </p>
            )}
            
            {bannerImage && (
              <div class="my-8 -mx-4 sm:mx-0 rounded-none sm:rounded-2xl overflow-hidden border-0 sm:border border-[var(--border-color)] shadow-2xl shadow-cyber-purple/10">
                {typeof bannerImage === 'string' ? (
                  <img 
                    src={bannerImage} 
                    alt={title}
                    class="w-full h-auto object-cover"
                    loading="eager"
                  />
                ) : (
                  <Image
                    src={bannerImage}
                    alt={title}
                    width={1200}
                    height={675}
                    class="w-full h-auto object-cover"
                    loading="eager"
                  />
                )}
              </div>
            )}
            
            <div class="flex flex-wrap items-center gap-4 text-sm">
              {formattedDate && (
                <div class="flex items-center gap-2 text-[var(--text-secondary)]">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <time datetime={date} class="font-medium">{formattedDate}</time>
                </div>
              )}
            </div>
            
            {tags && tags.length > 0 && (
              <div class="flex flex-wrap gap-2 mt-6">
                {tags.map((tag: string) => (
                  <span class="text-sm px-4 py-2 bg-cyber-purple/10 border border-cyber-purple/30 rounded-full text-cyber-purple font-medium">
                    #{tag}
                  </span>
                ))}
              </div>
            )}
          </header>
          
          <!-- Article content with enhanced styling -->
          <div class="blog-content">
            <slot />
          </div>
          
          <!-- Back to blog footer -->
          <footer class="mt-16 pt-8 border-t border-[var(--border-color)]">
            <a href="/blog" class="group inline-flex items-center gap-2 text-cyber-purple hover:text-cyber-cyan transition-colors font-medium">
              <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              View all posts
            </a>
          </footer>
        </article>
      </div>

      <!-- Desktop TOC Sidebar -->
      {tocHeadings.length > 0 && (
        <aside class="hidden lg:block lg:w-64 xl:w-72 flex-shrink-0">
          <div class="sticky top-8">
            <div class="bg-[var(--bg-elevated)] backdrop-blur-sm border border-[var(--border-color)] rounded-2xl p-6 shadow-xl">
              <h2 class="text-lg font-bold mb-4 cyber-text">
                Table of Contents
              </h2>
              <nav class="toc-nav">
                <ul class="space-y-1">
                  {tocHeadings.map((heading: any) => (
                    <li style={`margin-left: ${(heading.depth - 2) * 0.75}rem`}>
                      <a 
                        href={`#${heading.slug}`}
                        class="toc-link block py-2 px-3 text-[var(--text-secondary)] hover:text-cyber-purple hover:bg-cyber-purple/10 rounded transition-all text-sm border-l-2 border-transparent hover:border-cyber-purple"
                        data-heading-id={heading.slug}
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            </div>
          </div>
        </aside>
      )}
    </div>
  </div>
</Layout>

<style is:global>
  /* Override base layout styles for blog posts */
  html, body {
    overflow: visible !important;
    height: auto !important;
  }
  
  /* Blog content styles with enhanced typography */
  .blog-content {
    color: var(--text-primary);
    font-size: 1.125rem;
    line-height: 1.8;
  }
  
  .blog-content h1,
  .blog-content h2,
  .blog-content h3,
  .blog-content h4,
  .blog-content h5,
  .blog-content h6 {
    color: var(--text-primary);
    font-weight: 700;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    line-height: 1.3;
    background: linear-gradient(to right, var(--color-cyber-blue), var(--color-cyber-purple));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    scroll-margin-top: 2rem;
  }
  
  .blog-content h1 { font-size: 2.25rem; }
  .blog-content h2 { font-size: 1.875rem; }
  .blog-content h3 { font-size: 1.5rem; }
  .blog-content h4 { font-size: 1.25rem; }
  
  .blog-content p {
    margin-bottom: 1.5rem;
    line-height: 1.8;
    color: var(--text-secondary);
  }
  
  .blog-content a {
    color: var(--color-cyber-purple);
    text-decoration: underline;
    text-decoration-color: var(--color-cyber-purple);
    text-decoration-thickness: 1px;
    text-underline-offset: 3px;
    transition: all 0.2s;
  }
  
  .blog-content a:hover {
    color: var(--color-cyber-cyan);
    text-decoration-color: var(--color-cyber-cyan);
  }
  
  .blog-content img {
    border-radius: 1rem;
    margin-top: 3rem;
    margin-bottom: 3rem;
    width: 100%;
    height: auto;
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 50px var(--color-cyber-purple);
  }
  
  .blog-content ul,
  .blog-content ol {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
  }
  
  .blog-content li {
    margin-bottom: 0.75rem;
    padding-left: 0.5rem;
    color: var(--text-secondary);
  }
  
  .blog-content ul li {
    list-style-type: none;
    position: relative;
  }
  
  .blog-content ul li::before {
    content: "▹";
    position: absolute;
    left: -1.5rem;
    color: var(--color-terminal-green);
    font-weight: bold;
  }
  
  .blog-content ol li {
    list-style-type: decimal;
    list-style-position: outside;
  }
  
  .blog-content ol li::marker {
    color: var(--color-cyber-purple);
    font-weight: bold;
  }
  
  .blog-content code {
    background: var(--bg-elevated);
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.9em;
    color: var(--color-terminal-yellow);
    border: 1px solid var(--border-color);
    font-family: 'Courier New', monospace;
  }
  
  .blog-content pre {
    background: var(--bg-elevated);
    padding: 1.5rem;
    border-radius: 1rem;
    overflow-x: auto;
    margin: 2rem 0;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  }
  
  .blog-content pre code {
    background: transparent;
    padding: 0;
    border: none;
    color: var(--text-primary);
    box-shadow: none;
  }
  
  .blog-content blockquote {
    border-left: 4px solid var(--color-cyber-purple);
    padding-left: 1.5rem;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    font-style: italic;
    color: var(--text-secondary);
    margin: 2rem 0;
    background: var(--bg-elevated);
    border-radius: 0 0.5rem 0.5rem 0;
  }
  
  .blog-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid var(--border-color);
  }
  
  .blog-content th,
  .blog-content td {
    border: 1px solid var(--border-color);
    padding: 0.75rem 1rem;
    text-align: left;
  }
  
  .blog-content th {
    background: var(--bg-elevated);
    font-weight: 700;
    color: var(--color-cyber-purple);
  }
  
  .blog-content tr:nth-child(even) {
    background: var(--bg-elevated);
  }
  
  .blog-content hr {
    border: none;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--border-color), transparent);
    margin: 3rem 0;
  }
  
  .blog-content strong {
    color: var(--text-primary);
    font-weight: 700;
  }
  
  .blog-content em {
    color: var(--text-secondary);
  }

  /* TOC Active Link Styles */
  .toc-link.active {
    color: var(--color-cyber-purple);
    background: var(--color-cyber-purple);
    border-left-color: var(--color-cyber-purple);
  }

  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }
</style>

<script>
  // Mobile TOC toggle functionality
  const mobileToggle = document.getElementById('mobile-toc-toggle');
  const mobileOverlay = document.getElementById('mobile-toc-overlay');
  const mobileClose = document.getElementById('mobile-toc-close');

  if (mobileToggle && mobileOverlay && mobileClose) {
    mobileToggle.addEventListener('click', () => {
      mobileOverlay.classList.remove('hidden');
    });

    mobileClose.addEventListener('click', () => {
      mobileOverlay.classList.add('hidden');
    });

    mobileOverlay.addEventListener('click', (e) => {
      if (e.target === mobileOverlay) {
        mobileOverlay.classList.add('hidden');
      }
    });

    // Close mobile TOC when clicking a link
    const mobileTocLinks = mobileOverlay.querySelectorAll('.toc-link');
    mobileTocLinks.forEach(link => {
      link.addEventListener('click', () => {
        mobileOverlay.classList.add('hidden');
      });
    });
  }

  // Active section highlighting with intersection observer
  const observerOptions = {
    rootMargin: '-80px 0px -80% 0px',
    threshold: 0
  };

  const headingElements = document.querySelectorAll('.blog-content h2, .blog-content h3');
  const tocLinks = document.querySelectorAll('.toc-link');

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        // Remove active class from all links
        tocLinks.forEach(link => link.classList.remove('active'));
        // Add active class to current link
        const activeLink = document.querySelector(`.toc-link[data-heading-id="${id}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    });
  }, observerOptions);

  headingElements.forEach(heading => observer.observe(heading));
</script>

